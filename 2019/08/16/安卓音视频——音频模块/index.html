<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
<meta name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">

    <meta name="author" content="York">





<title>安卓音视频——音频模块 | York&#39;s blog</title>



    <link rel="icon" href="/favicon.ico">




    <!-- stylesheets list from _config.yml -->
    
    <link rel="stylesheet" href="/css/style.css">
    



    <!-- scripts list from _config.yml -->
    
    <script src="/js/script.js"></script>
    
    <script src="/js/tocbot.min.js"></script>
    



    
    
        
    


<meta name="generator" content="Hexo 6.3.0"></head>

<body>
    <script>
        // this function is used to check current theme before page loaded.
        (() => {
            const currentTheme = window.localStorage && window.localStorage.getItem('theme') || '';
            const isDark = currentTheme === 'dark';
            const pagebody = document.getElementsByTagName('body')[0]
            if (isDark) {
                pagebody.classList.add('dark-theme');
                // mobile
                document.getElementById("mobile-toggle-theme").innerText = "· Dark"
            } else {
                pagebody.classList.remove('dark-theme');
                // mobile
                document.getElementById("mobile-toggle-theme").innerText = "· Light"
            }
        })();
    </script>

    <div class="wrapper">
        <header>
    <nav class="navbar">
        <div class="container">
            <div class="navbar-header header-logo"><a href="/">Do It</a></div>
            <div class="menu navbar-right">
                
                    <a class="menu-item" href="/category">Categories</a>
                
                    <a class="menu-item" href="/tag">Tags</a>
                
                    <a class="menu-item" href="/archives">Archives</a>
                
                    <a class="menu-item" href="/about">About</a>
                
                <input id="switch_default" type="checkbox" class="switch_default">
                <label for="switch_default" class="toggleBtn"></label>
            </div>
        </div>
    </nav>

    
    <nav class="navbar-mobile" id="nav-mobile">
        <div class="container">
            <div class="navbar-header">
                <div>
                    <a href="/">Do It</a><a id="mobile-toggle-theme">·&nbsp;Light</a>
                </div>
                <div class="menu-toggle" onclick="mobileBtn()">&#9776; Menu</div>
            </div>
            <div class="menu" id="mobile-menu">
                
                    <a class="menu-item" href="/category">Categories</a>
                
                    <a class="menu-item" href="/tag">Tags</a>
                
                    <a class="menu-item" href="/archives">Archives</a>
                
                    <a class="menu-item" href="/about">About</a>
                
            </div>
        </div>
    </nav>

</header>
<script>
    var mobileBtn = function f() {
        var toggleMenu = document.getElementsByClassName("menu-toggle")[0];
        var mobileMenu = document.getElementById("mobile-menu");
        if(toggleMenu.classList.contains("active")){
           toggleMenu.classList.remove("active")
            mobileMenu.classList.remove("active")
        }else{
            toggleMenu.classList.add("active")
            mobileMenu.classList.add("active")
        }
    }
</script>
            <div class="main">
                <div class="container">
    
    
        <div class="post-toc">
    <div class="tocbot-list">
    </div>
    <div class="tocbot-list-menu">
        <a class="tocbot-toc-expand" onclick="expand_toc()">Expand all</a>
        <a onclick="go_top()">Back to top</a>
        <a onclick="go_bottom()">Go to bottom</a>
    </div>
</div>

<script>
    var tocbot_timer;
    var DEPTH_MAX = 6; // 为 6 时展开所有
    var tocbot_default_config = {
        tocSelector: '.tocbot-list',
        contentSelector: '.post-content',
        headingSelector: 'h1, h2, h3, h4, h5',
        orderedList: false,
        scrollSmooth: true,
        onClick: extend_click,
    };

    function extend_click() {
        clearTimeout(tocbot_timer);
        tocbot_timer = setTimeout(function() {
            tocbot.refresh(obj_merge(tocbot_default_config, {
                hasInnerContainers: true
            }));
        }, 420); // 这个值是由 tocbot 源码里定义的 scrollSmoothDuration 得来的
    }

    document.ready(function() {
        tocbot.init(obj_merge(tocbot_default_config, {
            collapseDepth: 1
        }));
    });

    function expand_toc() {
        var b = document.querySelector('.tocbot-toc-expand');
        var expanded = b.getAttribute('data-expanded');
        expanded ? b.removeAttribute('data-expanded') : b.setAttribute('data-expanded', true);
        tocbot.refresh(obj_merge(tocbot_default_config, {
            collapseDepth: expanded ? 1 : DEPTH_MAX
        }));
        b.innerText = expanded ? 'Expand all' : 'Collapse all';
    }

    function go_top() {
        window.scrollTo(0, 0);
    }

    function go_bottom() {
        window.scrollTo(0, document.body.scrollHeight);
    }

    function obj_merge(target, source) {
        for (var item in source) {
            if (source.hasOwnProperty(item)) {
                target[item] = source[item];
            }
        }
        return target;
    }
</script>
    

    
    <article class="post-wrap">
        <header class="post-header">
            <h1 class="post-title">安卓音视频——音频模块</h1>
            
                <div class="post-meta">
                    
                        Author: <a itemprop="author" rel="author" href="/">York</a>
                    

                    
                        <span class="post-time">
                        Date: <a href="#">2019 /08 /16&nbsp;&nbsp;14:19:00</a>
                        </span>
                    
                    
                </div>
            
        </header>

        <div class="post-content">
            <p>这是关于安卓音视频的一个系列文章。大家可以从这里随意跳跃：</p>
<p><a href="http://york-2016.github.io/2019/08/14/%E5%AE%89%E5%8D%93%E9%9F%B3%E8%A7%86%E9%A2%91%E2%80%94%E2%80%94%E5%9F%BA%E7%A1%80%E7%AF%87/" title="安卓音视频——基础篇">《安卓音视频》</a></p>
<p><a href="http://york-2016.github.io/2019/08/16/%E5%AE%89%E5%8D%93%E9%9F%B3%E8%A7%86%E9%A2%91%E2%80%94%E2%80%94%E9%9F%B3%E9%A2%91%E6%A8%A1%E5%9D%97/" title="安卓音视频——音频模块">《安卓音视频——音频模块》</a></p>
<p><a href="http://york-2016.github.io/2019/08/20/%E5%AE%89%E5%8D%93%E9%9F%B3%E8%A7%86%E9%A2%91%E2%80%94%E2%80%94%E5%9B%BE%E5%83%8F%E6%A8%A1%E5%9D%97/" title="安卓音视频——编解码">《安卓音视频——编解码》</a></p>
<blockquote>
<p>摘要：音频模块我将主要分 音频文件、音频录制、音频播放三大部分来叙述。音频文件将会重点描述音频的格式及编码；音频录制将介绍安卓中所有的可以录制音频的API；音频播放将介绍如何对音频文件进行播放。</p>
</blockquote>
<h1 id="1-音频文件"><a href="#1-音频文件" class="headerlink" title="1.音频文件"></a>1.音频文件</h1><p>顾名思义，音频文件指的就是储存着音频的文件，其格式有 PCM、WAV、MP3、OGG、AAC、M4A等，之所以有不同格式的音频文件是因为其编码方式不同。</p>
<p>我们在日常生活中所用的大部分音频文件的编码都采用了PCM 编码，其能够达到音频数据最高保真的水平，因此能满足大众娱乐的各种需求。</p>
<p>可是，PCM 编码高保真的特性意味着要占用更大的存储空间，所以高音质和小存储成为了互相制约的问题，为了中和考虑这2方面，音频格式也就出现了<strong>非压缩</strong>（如：WAV）和 <strong>压缩</strong>(如：MP3)两类。</p>
<p>所谓 <strong>音频压缩</strong> 是指通过不同的计算方式，忽略人耳不易察觉的频段或者通过制造听觉上的错觉，大幅度降低音频数据的数量，而音质基本不变甚至更好。音频压缩分为了 <strong>有损压缩</strong> （如：AAC、M4A）和 <strong>无损压缩</strong>（如：FLAC、APE） 2种，如下图所示：</p>
<p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly93d3cueW9ya3l1ZS5jb20vcGljcy9jdXRfYXVkaW9fbW9kZXlzLnBuZw?x-oss-process=image/format,png" alt="在这里插入图片描述"></p>
<p><strong>注</strong>：再次强调一下上一篇文章里的内容，PCM不是一种音频格式，它是声音文件的元数据，也就是声音的数据，用的是PCM编码，没有文件头。需要经过某种格式的压缩、编码算法处理以后，再加上这种格式的文件头，才是这种格式的音频文件。</p>
<p>好了，接下来我们会围绕部分音频格式，重点讲解安卓系统种用到的 音频录制与播放功能。</p>
<h1 id="2-音频录制"><a href="#2-音频录制" class="headerlink" title="2.音频录制"></a>2.音频录制</h1><p>安卓系统提供了4种音频录制的API,开发者可以根据应用场景，选择不同的API实现音频文件的录制功能，其中包括：</p>
<ol>
<li>通过Intent调用系统的录音器功能</li>
<li>MediaRecorder 录制音频</li>
<li>AudioRecorder 录制音频</li>
<li>OpenSL ES 录制音频</li>
</ol>
<p>安卓下录制音频需要录音权限、文件写入权限</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;uses-permission android:name=<span class="string">&quot;android.permission.WRITE_EXTERNAL_STORAGE&quot;</span> /&gt;</span><br><span class="line">&lt;uses-permission android:name=<span class="string">&quot;android.permission.RECORD_AUDIO&quot;</span> /&gt;</span><br></pre></td></tr></table></figure>

<h2 id="2-1-通过Intent调用系统的录音器功能"><a href="#2-1-通过Intent调用系统的录音器功能" class="headerlink" title="2.1 通过Intent调用系统的录音器功能"></a>2.1 通过Intent调用系统的录音器功能</h2><p>① 通过Intent调用系统的录音器功能，录制完毕后 保存的音频文件路径 uri 会在onActivityResult中返回。</p>
<pre><code>private final static int REQUEST_RECORDER = 1;
private Uri uri;

//去录制
public void startRecord()&#123;
    Intent intent = new Intent(MediaStore.Audio.Media.RECORD_SOUND_ACTION);
    startActivityForResult(intent,REQUEST_RECORDER);
&#125;
</code></pre>
<p>② 在onActivityResult获取返回信息</p>
<pre><code>@Override
protected void onActivityResult(int requestCode, int resultCode, Intent data) &#123;
    super.onActivityResult(requestCode, resultCode, data);
    if (resultCode == RESULT_OK &amp;&amp; REQUEST_RECORDER == requestCode)&#123;
        //返回 uri
        uri = data.getData();
    &#125;
&#125;
</code></pre>
<h2 id="2-2-通过MediaRecorder来录制音频"><a href="#2-2-通过MediaRecorder来录制音频" class="headerlink" title="2.2 通过MediaRecorder来录制音频"></a>2.2 通过MediaRecorder来录制音频</h2><p>MediaRecorder 类可用于<strong>音频</strong>和<strong>视频</strong>的录制。虽然已经集成了录音、编码、压缩，但只支持少量的音频格式录制，大概有.aac .amr .3gp等；不支持 wav、mp3。示例如下：</p>
<pre><code>    private MediaRecorder mRecorder;
    private boolean isRecording = false;
    private String mFileName=&quot;text.aac&quot;;
    /**
     * 开始录制
     */
    private void startRecord() &#123;
        try &#123;
            // 如果正在录音，那么停止并释放MediaRecorder
            if (isRecording &amp;&amp; mRecorder != null) &#123;
                mRecorder.stop();
                mRecorder.release();
                mRecorder = null;
            &#125;
            // 实例化 MediaRecorder
            mRecorder = new MediaRecorder();
            // 设置声音源为麦克风
            mRecorder.setAudioSource(MediaRecorder.AudioSource.MIC);
            // 设置输出格式为 aac
            mRecorder.setOutputFormat(MediaRecorder.OutputFormat.AAC_ADTS);
            // 设置输出文件路径，mFileName为录音音频输出路径
            mRecorder.setOutputFile(mFileName);
            // 设置声音解码 AAC
            mRecorder.setAudioEncoder(MediaRecorder.AudioEncoder.AAC);
            // 媒体录制器准备
            mRecorder.prepare();
            // 开始录制
            mRecorder.start();
            isRecording = true;
        &#125; catch (IOException e) &#123;
            e.printStackTrace();
        &#125;
    &#125;

    /**
     * 停止录制
     */
    private void stopRecord() &#123;
        if (isRecording &amp;&amp; mRecorder != null) &#123;
            mRecorder.stop();
            mRecorder.release();
            mRecorder = null;
        &#125;
    &#125;
</code></pre>
<h2 id="2-3-通过AudioRecorder来录制音频"><a href="#2-3-通过AudioRecorder来录制音频" class="headerlink" title="2.3 通过AudioRecorder来录制音频"></a>2.3 通过AudioRecorder来录制音频</h2><p>输出的是 PCM 的声音数据，如果要得到直接能播放的文件，则需要经过编码；AudioRecorder的特点是可以捕获到声音的原始数据——音频流，可以边录制边对音频数据进行处理，比如编码、变声、混音等。示例如下：</p>
<pre><code>    // 录音状态
    private boolean isRecording = true;

    /**
     * 开始录音
     */
    private void startRecord()&#123;
        // 录音为耗时操作，开线程
        new Thread()&#123;
            @Override
            public void run() &#123;
                // 设置音频输入源
                int audioSource = MediaRecorder.AudioSource.MIC;
                // 设置音频采样率
                int sampleRate = 44100;
                // 设置音频声道数
                int channelConfig = AudioFormat.CHANNEL_IN_STEREO;//双声道
                // 设置音频采样位数
                int audioFormat = AudioFormat.ENCODING_PCM_16BIT;
                // 获取最小缓存区大小
                int minBufferSize = AudioRecord.getMinBufferSize(sampleRate, channelConfig, audioFormat);
                // 创建录音对象
                AudioRecord audioRecord = new AudioRecord(audioSource, sampleRate, channelConfig, audioFormat, minBufferSize);
                try &#123;
                    // 开始
                    audioRecord.startRecording();
                    isRecording = true;
                    while (isRecording) &#123;
                        int readSize = audioRecord.read(buffer, 0, minBufferSize);
                        //buffer 即：录音得到的音频原始 PCM 数据,可以对音频数据进行各种处理，如：混音、变调、降噪、编码、边录边播、保存等操作
                        //readSize 即：每次输出的音频原始 PCM 数据确切长度
                    &#125;

                    // 录音停止
                    audioRecord.stop();
                    // 释放
                    audioRecord.release();
                &#125; catch (IOException e) &#123;
                    e.printStackTrace();
                &#125;
            &#125;
        &#125;.start();
    &#125;

    /**
     * 停止录音
     */
    private void stop() &#123;
        // 停止录音
        isRecording = false;
    &#125;
</code></pre>
<h2 id="2-4-通过OpenSL-ES来录制音频"><a href="#2-4-通过OpenSL-ES来录制音频" class="headerlink" title="2.4 通过OpenSL ES来录制音频"></a>2.4 通过OpenSL ES来录制音频</h2><p><strong>重点来了</strong>，后续我们的播放器SDK将要用 OpenSL ES 来处理整个音频部分的录制与播放。</p>
<blockquote>
<p><strong>OpenSL ES</strong> (Open Sound Library for Embedded Systems)是无授权费、跨平台、针对嵌入式系统精心优化的硬件音频加速API。它为嵌入式移动多媒体设备上的本地应用程序开发者提供标准化, 高性能,低响应时间的音频功能实现方法，并实现软&#x2F;硬件音频性能的直接跨平台部署，降低执行难度，促进高级音频市场的发展。简单来说OpenSL ES是一个嵌入式跨平台免费的音频处理库。</p>
</blockquote>
<p>OpenSL ES 的开发流程主要有如下6个步骤：</p>
<ol>
<li>创建接口对象</li>
<li>设置混音器</li>
<li>创建录音器（播放器）</li>
<li>设置缓冲队列和回调函数</li>
<li>设置播放状态</li>
<li>启动回调函数</li>
</ol>
<p>OpenSL ES 可以根据开发者的需要，定制几乎可以满足一切安卓音频所需要的功能，十分的强大。我们采用NDK开发来，从而对OpenSL ES的音频功能进行逐个实现。</p>
<p>首先，要使用OpenSL ES的API，需要引入OpenSL ES的头文件，代码如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;SLES/OpenSLES.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;SLES/OpenSLES_Android.h&gt;</span></span></span><br></pre></td></tr></table></figure>

<p>我发现讲概念好像不怎么通俗易懂，哎！来来来，直接看我封装的，上 代码：</p>
<p>OpenSLHelp.h</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Created by 86158 on 2019/8/22.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> YorkAUDIO_OPENSLHELP_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> YorkAUDIO_OPENSLHELP_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;SLES/OpenSLES.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;SLES/OpenSLES_Android.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;tgmath.h&gt;</span></span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">OpenSLHelp</span> &#123;</span></span><br><span class="line"></span><br><span class="line">public:</span><br><span class="line"></span><br><span class="line">    <span class="comment">//引擎接口</span></span><br><span class="line">    SLObjectItf engineObject;</span><br><span class="line">    SLEngineItf engineInterface;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//混音器</span></span><br><span class="line">    SLObjectItf outputMixObject;</span><br><span class="line">    SLEnvironmentalReverbItf outputMixEnvironmentalReverb;</span><br><span class="line">    SLEnvironmentalReverbSettings reverbSettings;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//pcm播放</span></span><br><span class="line">    SLObjectItf playerObject;</span><br><span class="line">    SLPlayItf playInterface;</span><br><span class="line"></span><br><span class="line">    SLVolumeItf pcmVolumePlay ;</span><br><span class="line">    SLMuteSoloItf  pcmMutePlay ;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//pcm录音</span></span><br><span class="line">    SLObjectItf recorderObject;</span><br><span class="line">    SLRecordItf recorderInterface;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//缓冲器队列接口</span></span><br><span class="line">    SLAndroidSimpleBufferQueueItf queueInterface;</span><br><span class="line">    SLDataLocator_AndroidSimpleBufferQueue android_queue;</span><br><span class="line">    SLDataFormat_PCM formatPCM;</span><br><span class="line">    SLDataLocator_OutputMix outputMix;</span><br><span class="line">    SLDataLocator_IODevice device;</span><br><span class="line"></span><br><span class="line">    SLDataSource source;</span><br><span class="line">    SLDataSink sink;</span><br><span class="line"></span><br><span class="line">public:</span><br><span class="line">    OpenSLHelp();</span><br><span class="line">    ~OpenSLHelp();</span><br><span class="line"></span><br><span class="line">    <span class="type">void</span> <span class="title function_">openSLHelperInit</span><span class="params">()</span>;</span><br><span class="line">    <span class="type">void</span> <span class="title function_">playDestroy</span><span class="params">()</span>;</span><br><span class="line">    <span class="type">void</span> <span class="title function_">recordDestroy</span><span class="params">()</span>;</span><br><span class="line">    SLuint32 <span class="title function_">getChannelMask</span><span class="params">(<span class="type">int</span> numChannels)</span>;</span><br><span class="line">    SLuint32 <span class="title function_">getCurrentSampleRateForOpensles</span><span class="params">(<span class="type">int</span> sample_rate)</span>;</span><br><span class="line">    SLuint32 <span class="title function_">getCurrentFormatForOpensles</span><span class="params">(<span class="type">int</span> file_bit)</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">//YorkAUDIO_OPENSLHELP_H</span></span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>OpenSLHelp.cpp</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Created by 86158 on 2019/8/22.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;OpenSLHelp.h&quot;</span></span></span><br><span class="line"></span><br><span class="line">OpenSLHelp::OpenSLHelp() &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">OpenSLHelp::~OpenSLHelp() &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">OpenSLHelp::openSLHelperInit</span><span class="params">()</span> &#123;</span><br><span class="line">    engineObject = <span class="literal">NULL</span>;</span><br><span class="line">    engineInterface = <span class="literal">NULL</span>;</span><br><span class="line">    recorderObject = <span class="literal">NULL</span>;</span><br><span class="line">    recorderInterface = <span class="literal">NULL</span>;</span><br><span class="line">    outputMixObject = <span class="literal">NULL</span>;</span><br><span class="line">    playerObject = <span class="literal">NULL</span>;</span><br><span class="line">    playInterface = <span class="literal">NULL</span>;</span><br><span class="line">    outputMixEnvironmentalReverb = <span class="literal">NULL</span>;</span><br><span class="line">    reverbSettings = SL_I3DL2_ENVIRONMENT_PRESET_STONECORRIDOR;</span><br><span class="line">    <span class="comment">//初始化openSL</span></span><br><span class="line">    slCreateEngine(&amp;engineObject, <span class="number">0</span>, <span class="literal">NULL</span>, <span class="number">0</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line">    (*engineObject)-&gt;Realize(engineObject, SL_BOOLEAN_FALSE);</span><br><span class="line">    (*engineObject)-&gt;GetInterface(engineObject, SL_IID_ENGINE, &amp;engineInterface);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">OpenSLHelp::playDestroy</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (playerObject != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        (*playerObject)-&gt;Destroy(playerObject);</span><br><span class="line">        playerObject = <span class="literal">NULL</span>;</span><br><span class="line">        playInterface = <span class="literal">NULL</span>;</span><br><span class="line">        pcmMutePlay = <span class="literal">NULL</span>;</span><br><span class="line">        pcmVolumePlay = <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (playerObject == <span class="literal">NULL</span>&amp;&amp;outputMixObject!=<span class="literal">NULL</span>)&#123;</span><br><span class="line">        (*outputMixObject)-&gt;Destroy(outputMixObject);</span><br><span class="line">        outputMixObject=<span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (playerObject == <span class="literal">NULL</span> &amp;&amp; recorderObject == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (queueInterface != <span class="literal">NULL</span>) &#123;</span><br><span class="line">            queueInterface = <span class="literal">NULL</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (engineObject != <span class="literal">NULL</span>) &#123;</span><br><span class="line">            (*engineObject)-&gt;Destroy(engineObject);</span><br><span class="line">            engineObject = <span class="literal">NULL</span>;</span><br><span class="line">            engineInterface = <span class="literal">NULL</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">OpenSLHelp::recordDestroy</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (recorderObject != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        (*recorderObject)-&gt;Destroy(recorderObject);</span><br><span class="line">        recorderObject = <span class="literal">NULL</span>;</span><br><span class="line">        recorderInterface = <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (playerObject == <span class="literal">NULL</span> &amp;&amp; recorderObject == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (queueInterface != <span class="literal">NULL</span>) &#123;</span><br><span class="line">            queueInterface = <span class="literal">NULL</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (engineObject != <span class="literal">NULL</span>) &#123;</span><br><span class="line">            (*engineObject)-&gt;Destroy(engineObject);</span><br><span class="line">            engineObject = <span class="literal">NULL</span>;</span><br><span class="line">            engineInterface = <span class="literal">NULL</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//通道设置</span></span><br><span class="line">SLuint32 <span class="title function_">OpenSLHelp::getChannelMask</span><span class="params">(<span class="type">int</span> numChannels)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> numChannels &gt; <span class="number">1</span> ? SL_SPEAKER_FRONT_LEFT | SL_SPEAKER_FRONT_RIGHT</span><br><span class="line">                           : SL_SPEAKER_FRONT_CENTER;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//位深设置</span></span><br><span class="line">SLuint32 <span class="title function_">OpenSLHelp::getCurrentFormatForOpensles</span><span class="params">(<span class="type">int</span> file_format)</span> &#123;</span><br><span class="line">    SLuint32 bit;</span><br><span class="line">    <span class="keyword">switch</span> (file_format) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">8</span>:</span><br><span class="line">            bit = SL_PCMSAMPLEFORMAT_FIXED_8;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">16</span>:</span><br><span class="line">            bit = SL_PCMSAMPLEFORMAT_FIXED_16;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">24</span>:</span><br><span class="line">            bit = SL_PCMSAMPLEFORMAT_FIXED_24;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">32</span>:</span><br><span class="line">            bit = SL_PCMSAMPLEFORMAT_FIXED_32;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            bit = SL_PCMSAMPLEFORMAT_FIXED_16;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> bit;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//采样率设置</span></span><br><span class="line">SLuint32 <span class="title function_">OpenSLHelp::getCurrentSampleRateForOpensles</span><span class="params">(<span class="type">int</span> sample_rate)</span> &#123;</span><br><span class="line"></span><br><span class="line">    SLuint32 rate;</span><br><span class="line">    <span class="keyword">switch</span> (sample_rate) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">8000</span>:</span><br><span class="line">            rate = SL_SAMPLINGRATE_8;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">11025</span>:</span><br><span class="line">            rate = SL_SAMPLINGRATE_11_025;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">12000</span>:</span><br><span class="line">            rate = SL_SAMPLINGRATE_12;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">16000</span>:</span><br><span class="line">            rate = SL_SAMPLINGRATE_16;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">22050</span>:</span><br><span class="line">            rate = SL_SAMPLINGRATE_22_05;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">24000</span>:</span><br><span class="line">            rate = SL_SAMPLINGRATE_24;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">32000</span>:</span><br><span class="line">            rate = SL_SAMPLINGRATE_32;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">44100</span>:</span><br><span class="line">            rate = SL_SAMPLINGRATE_44_1;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">48000</span>:</span><br><span class="line">            rate = SL_SAMPLINGRATE_48;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">64000</span>:</span><br><span class="line">            rate = SL_SAMPLINGRATE_64;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">88200</span>:</span><br><span class="line">            rate = SL_SAMPLINGRATE_88_2;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">96000</span>:</span><br><span class="line">            rate = SL_SAMPLINGRATE_96;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">192000</span>:</span><br><span class="line">            rate = SL_SAMPLINGRATE_192;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            rate = SL_SAMPLINGRATE_44_1;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> rate;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>怎么用呢？，这是录制部分的代码</p>
<p>YorkRecorder.cpp</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Created by 86158 on 2019/8/21.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;YorkRecorder.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">YorkRecorder::YorkRecorder(YorkRecordstatus *recordstatus, OpenSLHelp *openSLHelp,</span><br><span class="line">                             RecordCallJava *callJava,  <span class="type">int</span> samplingRate,</span><br><span class="line">                             SLuint32 numChannels, <span class="type">int</span> format) &#123;</span><br><span class="line">    this-&gt;recordstatus = recordstatus;</span><br><span class="line">    this-&gt;openSLHelp = openSLHelp;</span><br><span class="line">    this-&gt;recordCallJava = callJava;</span><br><span class="line">    this-&gt;samplingRate = samplingRate;</span><br><span class="line">    this-&gt;numChannels = numChannels;</span><br><span class="line">    this-&gt;format = format;</span><br><span class="line">    recorderSize = samplingRate * numChannels * <span class="number">120</span> / <span class="number">1000</span>;<span class="comment">//兼容视频录制</span></span><br><span class="line">    yorkJiangzao = new YorkJiangzao();<span class="comment">//环境降噪算法</span></span><br><span class="line">    yorkRenSheng = new YorkRenSheng();<span class="comment">//人声增强算法</span></span><br><span class="line">    yorkLowCut = new YorkLowCut();<span class="comment">//低切算法</span></span><br><span class="line">    yorkGain = new YorkGain();<span class="comment">//增益调节算法</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">YorkRecorder::~YorkRecorder() &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">pcmBufferRecordCallBack</span><span class="params">(SLAndroidSimpleBufferQueueItf bf, <span class="type">void</span> *context)</span> &#123;</span><br><span class="line">    YorkRecorder *yorkRecorder = (YorkRecorder *) context;</span><br><span class="line">    <span class="keyword">if</span> (yorkRecorder != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!yorkRecorder-&gt;recordstatus-&gt;recording) &#123;</span><br><span class="line">            (*yorkRecorder-&gt;openSLHelp-&gt;recorderInterface)-&gt;SetRecordState(</span><br><span class="line">                    yorkRecorder-&gt;openSLHelp-&gt;recorderInterface, SL_RECORDSTATE_STOPPED);</span><br><span class="line">            fclose(yorkRecorder-&gt;pcmFile);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//降噪</span></span><br><span class="line">            <span class="keyword">if</span> (yorkRecorder-&gt;jz_rate &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                yorkRecorder-&gt;yorkJiangzao-&gt;doJiangzao(yorkRecorder-&gt;jz_rate,</span><br><span class="line">                                                       yorkRecorder-&gt;buffer,</span><br><span class="line">                                                       yorkRecorder-&gt;buffer,</span><br><span class="line">                                                       yorkRecorder-&gt;recorderSize,</span><br><span class="line">                                                       yorkRecorder-&gt;format);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//人声增强</span></span><br><span class="line">            <span class="keyword">if</span> (yorkRecorder-&gt;rs_rate != <span class="number">0</span>) &#123;</span><br><span class="line">                yorkRecorder-&gt;yorkRenSheng-&gt;doRenSheng(yorkRecorder-&gt;rs_rate,</span><br><span class="line">                                                       yorkRecorder-&gt;buffer,</span><br><span class="line">                                                       yorkRecorder-&gt;buffer,</span><br><span class="line">                                                       yorkRecorder-&gt;recorderSize,</span><br><span class="line">                                                       yorkRecorder-&gt;format);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//低切</span></span><br><span class="line">            <span class="keyword">if</span> (yorkRecorder-&gt;lc_rate != <span class="number">0</span>) &#123;</span><br><span class="line">                yorkRecorder-&gt;yorkLowCut-&gt;doLowCut(yorkRecorder-&gt;lc_rate,</span><br><span class="line">                                                   yorkRecorder-&gt;buffer,</span><br><span class="line">                                                   yorkRecorder-&gt;buffer,</span><br><span class="line">                                                   yorkRecorder-&gt;recorderSize,</span><br><span class="line">                                                   yorkRecorder-&gt;format,</span><br><span class="line">                                                   yorkRecorder-&gt;samplingRate);</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//增益调节</span></span><br><span class="line">            <span class="keyword">if</span> (yorkRecorder-&gt;gain_rate != <span class="number">1</span>) &#123;</span><br><span class="line">                yorkRecorder-&gt;yorkGain-&gt;setGain(yorkRecorder-&gt;gain_rate, yorkRecorder-&gt;buffer,</span><br><span class="line">                                                yorkRecorder-&gt;buffer,</span><br><span class="line">                                                yorkRecorder-&gt;recorderSize,</span><br><span class="line">                                                yorkRecorder-&gt;format);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//返回数据</span></span><br><span class="line">            yorkRecorder-&gt;recordCallJava-&gt;onCallRecordData(CHILD_THREAD, yorkRecorder-&gt;buffer,</span><br><span class="line">                                                           yorkRecorder-&gt;recorderSize);</span><br><span class="line">            <span class="comment">//做边录边播还有分贝</span></span><br><span class="line">            yorkRecorder-&gt;recordCallJava-&gt;onCallRecordPlaydata(CHILD_THREAD, yorkRecorder-&gt;buffer,</span><br><span class="line">                                                               yorkRecorder-&gt;recorderSize,</span><br><span class="line">                                                               yorkRecorder-&gt;format);</span><br><span class="line">            <span class="comment">//显示时间</span></span><br><span class="line">            <span class="keyword">if</span> (yorkRecorder-&gt;recordstatus-&gt;recordingsave) &#123;</span><br><span class="line">                yorkRecorder-&gt;recordCallJava-&gt;onCallRecordTime(CHILD_THREAD,</span><br><span class="line">                                                               yorkRecorder-&gt;timer.getTimeShow());</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//取完数据，需要调用Enqueue触发下一次数据回调</span></span><br><span class="line">            (*yorkRecorder-&gt;openSLHelp-&gt;queueInterface)-&gt;Enqueue(</span><br><span class="line">                    yorkRecorder-&gt;openSLHelp-&gt;queueInterface, yorkRecorder-&gt;buffer,</span><br><span class="line">                    yorkRecorder-&gt;recorderSize);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">YorkRecorder::recordOpenSLES</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (LOG_DEBUG) &#123;</span><br><span class="line">        LOGD(<span class="string">&quot;InitRecord : -- sample_rate= %d ,channels= %d ,format= %d&quot;</span>,  samplingRate, numChannels, format)</span><br><span class="line">    &#125;</span><br><span class="line">    buffer = (<span class="type">uint8_t</span> *) av_malloc(recorderSize);</span><br><span class="line">    <span class="comment">//创建引擎对象</span></span><br><span class="line">    openSLHelp-&gt;openSLHelperInit();</span><br><span class="line">    <span class="comment">//设置IO设备（麦克风）</span></span><br><span class="line">    openSLHelp-&gt;device = &#123;SL_DATALOCATOR_IODEVICE, SL_IODEVICE_AUDIOINPUT,</span><br><span class="line">                          SL_DEFAULTDEVICEID_AUDIOINPUT, <span class="literal">NULL</span>&#125;;</span><br><span class="line">    openSLHelp-&gt;source = &#123;&amp;openSLHelp-&gt;device, <span class="literal">NULL</span>&#125;;</span><br><span class="line">    <span class="comment">//设置buffer队列</span></span><br><span class="line">    openSLHelp-&gt;android_queue = &#123;SL_DATALOCATOR_ANDROIDSIMPLEBUFFERQUEUE, <span class="number">2</span>&#125;;</span><br><span class="line">    <span class="comment">//设置录制规格：PCM、2声道、44100HZ、16bit</span></span><br><span class="line">    openSLHelp-&gt;formatPCM = &#123;</span><br><span class="line">            SL_DATAFORMAT_PCM, numChannels,</span><br><span class="line">            openSLHelp-&gt;getCurrentSampleRateForOpensles(samplingRate),</span><br><span class="line">            openSLHelp-&gt;getCurrentFormatForOpensles(format),</span><br><span class="line">            openSLHelp-&gt;getCurrentFormatForOpensles(format),</span><br><span class="line">            openSLHelp-&gt;getChannelMask(numChannels),</span><br><span class="line">            SL_BYTEORDER_LITTLEENDIAN</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    openSLHelp-&gt;sink = &#123;&amp;openSLHelp-&gt;android_queue, &amp;openSLHelp-&gt;formatPCM&#125;;</span><br><span class="line"></span><br><span class="line">    SLInterfaceID id[] = &#123;SL_IID_ANDROIDSIMPLEBUFFERQUEUE&#125;;</span><br><span class="line">    SLboolean required[] = &#123;SL_BOOLEAN_TRUE&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//创建录制器</span></span><br><span class="line">    (*openSLHelp-&gt;engineInterface)-&gt;CreateAudioRecorder(</span><br><span class="line">            openSLHelp-&gt;engineInterface,</span><br><span class="line">            &amp;openSLHelp-&gt;recorderObject,</span><br><span class="line">            &amp;openSLHelp-&gt;source,</span><br><span class="line">            &amp;openSLHelp-&gt;sink,</span><br><span class="line">            <span class="number">1</span>,</span><br><span class="line">            id,</span><br><span class="line">            required);</span><br><span class="line">    (*openSLHelp-&gt;recorderObject)-&gt;Realize(openSLHelp-&gt;recorderObject, SL_BOOLEAN_FALSE);</span><br><span class="line">    (*openSLHelp-&gt;recorderObject)-&gt;GetInterface(openSLHelp-&gt;recorderObject, SL_IID_RECORD,</span><br><span class="line">                                                &amp;openSLHelp-&gt;recorderInterface);</span><br><span class="line">    (*openSLHelp-&gt;recorderObject)-&gt;GetInterface(openSLHelp-&gt;recorderObject,</span><br><span class="line">                                                SL_IID_ANDROIDSIMPLEBUFFERQUEUE,</span><br><span class="line">                                                &amp;openSLHelp-&gt;queueInterface);</span><br><span class="line">    (*openSLHelp-&gt;queueInterface)-&gt;Enqueue(openSLHelp-&gt;queueInterface, buffer, recorderSize);</span><br><span class="line">    (*openSLHelp-&gt;queueInterface)-&gt;RegisterCallback(openSLHelp-&gt;queueInterface,</span><br><span class="line">                                                    pcmBufferRecordCallBack, this);</span><br><span class="line">    recordstatus-&gt;recording = <span class="literal">true</span>;</span><br><span class="line">    <span class="comment">//开始录音</span></span><br><span class="line">    (*openSLHelp-&gt;recorderInterface)-&gt;SetRecordState(openSLHelp-&gt;recorderInterface,</span><br><span class="line">                                                     SL_RECORDSTATE_RECORDING);</span><br><span class="line">    <span class="keyword">if</span> (recordCallJava != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        recordCallJava-&gt;onCallRecordStart(CHILD_THREAD);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (LOG_DEBUG) &#123;</span><br><span class="line">        LOGD(<span class="string">&quot;Recorder started ...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> *<span class="title function_">timeSpace</span><span class="params">(<span class="type">void</span> *data)</span> &#123;</span><br><span class="line">    YorkRecorder *recorder = (YorkRecorder *) data;</span><br><span class="line">    <span class="keyword">while</span> (recorder-&gt;recordstatus-&gt;recording) &#123;</span><br><span class="line">        <span class="keyword">if</span> (recorder-&gt;recordstatus-&gt;recordingsave) &#123;</span><br><span class="line">            usleep(<span class="number">1000</span>);</span><br><span class="line">            recorder-&gt;recordCallJava-&gt;onCallTimeSpace(CHILD_THREAD, recorder-&gt;timer.getTimeShow());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    pthread_exit(&amp;recorder-&gt;thread_timeSpace);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 开始录制</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">YorkRecorder::startRecord</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">    yorkJiangzao-&gt;initJiangzao(recorderSize, samplingRate, numChannels, format);</span><br><span class="line">    yorkRenSheng-&gt;initRenSheng();</span><br><span class="line">    recordOpenSLES();</span><br><span class="line">    pthread_create(&amp;thread_timeSpace, <span class="literal">NULL</span>, timeSpace, this);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 暂停录制</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">YorkRecorder::pauseRecord</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (openSLHelp != <span class="literal">NULL</span> &amp;&amp; openSLHelp-&gt;recorderInterface != <span class="literal">NULL</span>) &#123;</span><br><span class="line"></span><br><span class="line">        (*openSLHelp-&gt;recorderInterface)-&gt;SetRecordState(openSLHelp-&gt;recorderInterface,</span><br><span class="line">                                                         SL_RECORDSTATE_PAUSED);</span><br><span class="line">        <span class="keyword">if</span> (recordCallJava != <span class="literal">NULL</span>) &#123;</span><br><span class="line">            recordCallJava-&gt;onCallRecordPause(CHILD_THREAD);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (LOG_DEBUG) &#123;</span><br><span class="line">            LOGD(<span class="string">&quot;Recorder paused ...&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 继续录制</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">YorkRecorder::resumeRecord</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (openSLHelp != <span class="literal">NULL</span> &amp;&amp; openSLHelp-&gt;recorderInterface != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        (*openSLHelp-&gt;recorderInterface)-&gt;SetRecordState(openSLHelp-&gt;recorderInterface,</span><br><span class="line">                                                         SL_RECORDSTATE_RECORDING);</span><br><span class="line">        <span class="keyword">if</span> (recordCallJava != <span class="literal">NULL</span>) &#123;</span><br><span class="line">            recordCallJava-&gt;onCallRecordStart(CHILD_THREAD);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (LOG_DEBUG) &#123;</span><br><span class="line">            LOGD(<span class="string">&quot;Recorder resumed ...&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 停止录制</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">YorkRecorder::stopRecord</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">    recordstatus-&gt;recording = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">if</span> (yorkJiangzao != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        yorkJiangzao-&gt;destryJiangzao();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (openSLHelp != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        SLuint32 state;</span><br><span class="line">        (*openSLHelp-&gt;recorderInterface)-&gt;GetRecordState(openSLHelp-&gt;recorderInterface, &amp;state);</span><br><span class="line">        <span class="keyword">if</span> (state == SL_RECORDSTATE_PAUSED || state == SL_RECORDSTATE_RECORDING) &#123;</span><br><span class="line">            (*openSLHelp-&gt;recorderInterface)-&gt;SetRecordState(openSLHelp-&gt;recorderInterface,</span><br><span class="line">                                                             SL_RECORDSTATE_STOPPED);</span><br><span class="line">        &#125;</span><br><span class="line">        openSLHelp-&gt;recordDestroy();</span><br><span class="line">        <span class="keyword">if</span> (LOG_DEBUG) &#123;</span><br><span class="line">            LOGD(<span class="string">&quot;Recorder already stoped !&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (recordCallJava != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        recordCallJava-&gt;onCallRecordStop(CHILD_THREAD);</span><br><span class="line">        recordCallJava=<span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">YorkRecorder::setJZ</span><span class="params">(<span class="type">int</span> jz_rate)</span> &#123;</span><br><span class="line">    this-&gt;jz_rate = jz_rate;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">YorkRecorder::setGain</span><span class="params">(<span class="type">double</span> gain_rate)</span> &#123;</span><br><span class="line">    this-&gt;gain_rate = gain_rate;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">YorkRecorder::setLC</span><span class="params">(<span class="type">int</span> lc_rate)</span> &#123;</span><br><span class="line">    this-&gt;lc_rate = lc_rate;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">YorkRecorder::setRenShenSwitch</span><span class="params">(<span class="type">double</span> rs_rate)</span> &#123;</span><br><span class="line">    this-&gt;rs_rate = rs_rate;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">YorkRecorder::getRecordStates</span><span class="params">()</span> &#123;</span><br><span class="line">    SLuint32 state;</span><br><span class="line">    <span class="type">int</span> ret = <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">if</span> (openSLHelp != <span class="literal">NULL</span> &amp;&amp; openSLHelp-&gt;recorderInterface != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        (*openSLHelp-&gt;recorderInterface)-&gt;GetRecordState(openSLHelp-&gt;recorderInterface,</span><br><span class="line">                                                         &amp;state);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (state == SL_RECORDSTATE_RECORDING) &#123;</span><br><span class="line">        ret = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">YorkRecorder::startRecordTime</span><span class="params">()</span> &#123;</span><br><span class="line">    recordstatus-&gt;recordingsave = <span class="literal">true</span>;</span><br><span class="line">    timer.Start();</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">YorkRecorder::pauseRecordTime</span><span class="params">()</span> &#123;</span><br><span class="line">    recordstatus-&gt;recordingsave = <span class="literal">false</span>;</span><br><span class="line">    timer.Pause();;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">YorkRecorder::resumeRecordTime</span><span class="params">()</span> &#123;</span><br><span class="line">    recordstatus-&gt;recordingsave = <span class="literal">true</span>;</span><br><span class="line">    timer.Start();</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">YorkRecorder::stopRecordTime</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (recordCallJava != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        recordCallJava-&gt;onCallRecordResult(CHILD_THREAD, timer.getTimeShow());</span><br><span class="line">    &#125;</span><br><span class="line">    recordstatus-&gt;recordingsave = <span class="literal">false</span>;</span><br><span class="line">    timer.Stop();</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这样就完成对OpenSL ES的音频录制功能封装。OpenSL ES还可以对音频进行播放，这部分我们在播放模块对它重点讲解。</p>
<p><em>以上，就是对安卓系统下的音频录制功能的介绍了。</em></p>
<h1 id="3-音频播放"><a href="#3-音频播放" class="headerlink" title="3.音频播放"></a>3.音频播放</h1><p>安卓系统提供了4种音频播放的API,开发者可以根据应用场景，选择不同的API实现对音频文件的播放。其中包括：</p>
<ol>
<li>AudioTrack 播放PCM音频</li>
<li>MediaPlayer 播放音频</li>
<li>SoundPool 播放音频</li>
<li>JetPlayer 播放 .jet音频</li>
<li>Ringtone 播放铃声音频</li>
<li>OpenSL ES 播放PCM音频</li>
</ol>
<h2 id="3-1-AudioTrack-播放音频"><a href="#3-1-AudioTrack-播放音频" class="headerlink" title="3.1 AudioTrack 播放音频"></a>3.1 AudioTrack 播放音频</h2><p>AudioTrack 属于偏底层的音频播放API，MediaPlayerService的内部就是使用了 AudioTrack。</p>
<p>AudioTrack 用于单个音频的播放，播放PCM 数据，任何一种音频解码成 PCM 后都可以用 AudioTrack 来播放，所以 AudioTrack 相比于MediaPlayer，具有更精炼、高效、灵活的优点。</p>
<p><strong>① AudioTreack 的2种播放模式</strong></p>
<ul>
<li><strong>静态模式—static</strong>：静态的言下之意就是数据一次性交付给接收方。好处是简单高效，只需要进行一次操作就完成了数据的传递;缺点当然也很明显，对于数据量较大的音频回放，显然它是无法胜任的，因而通常只用于播放铃声、系统提醒等对内存小的操作</li>
<li><strong>流模式-stream</strong>：流模式时数据是按照一定规律不断地传递给接收方的。理论上它可用于任何音频播放的场景，我们一般在音频文件过大、还有数据是实时产生的情况下，用流模式进行播放。</li>
</ul>
<p><strong>② AudioTreack 的播放示例</strong></p>
<p>播放前需要先设置音频的基本参数，用音频数据的采样率、位深、通道数初始化 AudioTreack。示例：</p>
<pre><code>    /**
     * 开始播放
     */
    private void startPlay()&#123;
        
        new Thread(new Runnable() &#123;
            @Override
            public void run() &#123;
                // 获取最小缓冲区
                int bufSize = AudioTrack.getMinBufferSize(44100, AudioFormat.CHANNEL_OUT_STEREO, AudioFormat.ENCODING_PCM_16BIT);
                // 实例化AudioTrack(设置缓冲区为最小缓冲区的2倍，至少要等于最小缓冲区)
                mAudioTrack = new AudioTrack(AudioManager.STREAM_MUSIC, 44100, AudioFormat.CHANNEL_OUT_STEREO,
                        AudioFormat.ENCODING_PCM_16BIT, bufSize, AudioTrack.MODE_STREAM);
                // 设置播放频率
                mAudioTrack.setPlaybackRate(10) ;
                mAudioTrack.play();
                // 获取音乐文件输入流
                InputStream is = getResources().openRawResource(R.raw.pcm_441_stereo_16);
                byte[] buffer = new byte[bufSize*2] ;
                int len ;
                try &#123;
                    while((len=is.read(buffer,0,buffer.length)) != -1)&#123;
                        // 将读取的数据，写入Audiotrack
                        audioTrack.write(buffer,0,buffer.length) ;
                    &#125;
                    is.close();
                &#125; catch (Exception e) &#123;
                    e.printStackTrace();
                &#125;
            &#125;
        &#125;).start();

    &#125;

    /**
     * 停止播放
     */
    private void stopPlay()&#123;
        if (this.mAudioTrack != null) &#123;
            this.mAudioTrack.stop();
            this.mAudioTrack.release();
            this.mAudioTrack = null;
        &#125;
    &#125;
</code></pre>
<p><em>以上就是对 AudioTreack 实现音频播放的整理。</em></p>
<h2 id="3-2-MediaPlayer-播放音频"><a href="#3-2-MediaPlayer-播放音频" class="headerlink" title="3.2 MediaPlayer 播放音频"></a>3.2 MediaPlayer 播放音频</h2><p>MediaPlayer 支持：AAC、AMR、FLAC、MP3、MIDI、OGG、PCM 等音频格式，也可以播放在线的流式资源。</p>
<p>MediaPlayer 播放时会在framework 层创建对应的音频解码器，创建 AudioTrack，然后把解码后的PCM数流传递给 AudioTrack，AudioTrack 再传递给 AudioFlinger 进行混音，然后才传递给硬件播放,所以可以说 MediaPlayer 包含了 AudioTrack。我们后期要讲的播放器封装也是一样的逻辑。</p>
<p>以下是对 MediaPlayer 播放功能的一个封装，其中包括 音频源的设置、播放、暂停、继续播放、停止播放、获取播放状态、播放进度控制等封装。代码如下：</p>
<pre><code>public class SampleMediaPlay implements OnPreparedListener, OnBufferingUpdateListener&#123;

    public MediaPlayer mediaPlayer; // 媒体播放器
    private Timer mTimer = new Timer(); // 计时器
    private StateChangeListener mStateChangeListener;
    private int presses=0;
    private int totaltime=0;
    private AudioManager mAudioManager;
    public SampleMediaPlay(StateChangeListener mStateChangeListener,AudioManager audioManager) &#123;
        super();
        this.mAudioManager=audioManager;
        this.mStateChangeListener=mStateChangeListener;
        try &#123;
            mediaPlayer = new MediaPlayer();
            mediaPlayer.setAudioStreamType(AudioManager.STREAM_MUSIC);// 设置媒体流类型
            mediaPlayer.setOnPreparedListener(this);
            mediaPlayer.setOnBufferingUpdateListener(this);
        &#125; catch (Exception e) &#123;
            e.printStackTrace();
        &#125;		
        mTimer.schedule(timerTask, 0, 50);
    &#125;
    private AudioManager.OnAudioFocusChangeListener mFocusChangeListener=new AudioManager.OnAudioFocusChangeListener() &#123;
        @Override
        public void onAudioFocusChange(int focusChange) &#123;
            if (focusChange == AudioManager.AUDIOFOCUS_LOSS_TRANSIENT) &#123;
                Log.e(&quot;york&quot;,&quot;短暂的失去焦点&quot;);
                pause();
            &#125; else if (focusChange == AudioManager.AUDIOFOCUS_GAIN) &#123;
                Log.e(&quot;york&quot;,&quot;重新获取到焦点&quot;);
                play();
            &#125; else if (focusChange == AudioManager.AUDIOFOCUS_LOSS) &#123;
                Log.e(&quot;york&quot;,&quot;长时间失去焦点哦&quot;);
                pause();
            &#125; else if (focusChange == AudioManager.AUDIOFOCUS_REQUEST_GRANTED) &#123;
                Log.e(&quot;york&quot;,&quot;焦点成功&quot;);
            &#125;
        &#125;
    &#125;;
    TimerTask timerTask = new TimerTask() &#123;

        @Override
        public void run() &#123;
            if (mediaPlayer == null)&#123;
                return;
            &#125;else if (mediaPlayer.isPlaying()) &#123;
                    handler.sendEmptyMessage(0); // 发送消息
            &#125;
        &#125;		
    &#125;;

    Handler handler = new Handler() &#123;
        public void handleMessage(android.os.Message msg) &#123;
            if (mediaPlayer == null)&#123;
                return;
            &#125;else if (mediaPlayer.isPlaying() ) &#123;
                mediaPlayer.getCurrentPosition();
                mediaPlayer.getDuration();
            &#125;
        &#125;;
    &#125;;
    // 设置数据源
    public void playUrl(String url) &#123;
        if (mediaPlayer != null) &#123;
            mAudioManager.requestAudioFocus(mFocusChangeListener,AudioManager.STREAM_MUSIC,AudioManager.AUDIOFOCUS_GAIN);
            try &#123;				
                mediaPlayer.setDataSource(url);
                mediaPlayer.prepareAsync();
                mStateChangeListener.onUpData();
            &#125; catch (Exception e) &#123;
                e.printStackTrace();
            &#125;
        &#125;
    &#125;
    //播放
    public void play() &#123;
        if (mediaPlayer != null) &#123;
            mAudioManager.requestAudioFocus(mFocusChangeListener,AudioManager.STREAM_MUSIC,AudioManager.AUDIOFOCUS_GAIN);
            if(!mediaPlayer.isPlaying())&#123;
                mediaPlayer.start();
                mStateChangeListener.onPlaying();
            &#125;
        &#125;
    &#125;

    // 暂停
    public void pause() &#123;
        if(mediaPlayer != null )&#123;
            if(mediaPlayer.isPlaying())&#123;
                mediaPlayer.pause();
                mStateChangeListener.onPauseing();
            &#125;
        &#125;
    &#125;

    // 停止
    public void stop() &#123;
        if (mediaPlayer != null) &#123;
            timerTask.cancel();
            mTimer.cancel();
            mTimer=null;
            mAudioManager.abandonAudioFocus(mFocusChangeListener);
            pause();
            if(mediaPlayer != null )&#123;
                if(mediaPlayer.isPlaying())&#123;
                    mediaPlayer.pause();
                &#125;
            &#125;
            mediaPlayer.stop();				
            mediaPlayer.release();
            mediaPlayer=null;		
        &#125;
    &#125;
    @Override
    public void onPrepared(MediaPlayer mp) &#123;
        mAudioManager.requestAudioFocus(mFocusChangeListener,AudioManager.STREAM_MUSIC,AudioManager.AUDIOFOCUS_GAIN);
        mp.start();
        mStateChangeListener.onPlaying();
    &#125;
    public int getCurrentPosition()&#123;
        if(mediaPlayer==null)&#123;
            return 0;
        &#125;else if(!mediaPlayer.isPlaying())&#123;
            return presses;
        &#125;else&#123;
            presses= mediaPlayer.getCurrentPosition();
            return presses;
        &#125;
    &#125;
    public int getDuration()&#123;
        if(mediaPlayer==null)&#123;
            return 0;
        &#125;else if(!mediaPlayer.isPlaying())&#123;
            return totaltime;
        &#125;else&#123;
            totaltime= mediaPlayer.getDuration();
            return totaltime;
        &#125;
    &#125;
    public void seekTo(int msec)&#123;
        mediaPlayer.seekTo(msec);
    &#125;
    @Override
    public void onBufferingUpdate(MediaPlayer mp, int percent) &#123;
    &#125;
&#125;
</code></pre>
<h2 id="3-3-SoundPool-播放音频"><a href="#3-3-SoundPool-播放音频" class="headerlink" title="3.3 SoundPool 播放音频"></a>3.3 SoundPool 播放音频</h2><p>SoundPool可以同时播放多个短促的音频，而且占用的资源较少，比较适合短促、密集的场景，适合在程序中播放按键音，或者消息提示音等，也长用于游戏开发中音效的播放。不过比较尴尬的是，已经被安卓弃用了。</p>
<p><strong>① SoundPool 构造器</strong></p>
<pre><code>        /**
         * 参数maxStreams：指定支持多少个声音；
         * 参数streamType：指定声音类型：
         * 参数srcQuality：指定声音品质。
         */
        new SoundPool(int maxStreams, int streamType, int srcQuality)
</code></pre>
<p>用以上实例化SoundPool对象</p>
<p><strong>②SoundPool加载音频</strong></p>
<p>在得到了SoundPool对象之后，接下来就可调用SoundPool的多个重载的load方法来加载声音了。</p>
<pre><code>//从 resld 所对应的资源加载声音。
int load(Context context, int resld, int priority)
//加载 fd 所对应的文件的offset开始、长度为length的声音。
int load(FileDescriptor fd, long offset, long length, int priority)
//从afd 所对应的文件中加载声音。
int load(AssetFileDescriptor afd, int priority)
//从path 对应的文件去加载声音。
int load(String path, int priority)
</code></pre>
<p>上面4个方法加载声音之后，返回该声音的ID，程序通过ID来播放该声音。</p>
<p><strong>③SoundPool播放指定ID声音</strong></p>
<pre><code>    /**
     * 参数soundID：指定播放哪个声音； 
     * 参数leftVolume、rightVolume：指定左、右的音量： 
     * 参数priority：指定播放声音的优先级，数值越大，优先级越高； 
     * 参数loop：指定是否循环，0：不循环，-1：循环，其他值表示要重复播放的次数；
     * 参数rate：指定播放的比率，数值可从0.5到2， 1为正常比率。
     */
     int play(int soundID, float leftVolume, float rightVolume, int priority, int loop, float rate)
</code></pre>
<p><strong>④释放</strong></p>
<p>最后，release()方法，用于释放所有SoundPool对象占据的内存和资源，也可以指定要释放的ID。</p>
<p>以上为 SoundPool 播放音频文件的方法。</p>
<h2 id="3-4-JetPlayer-播放音频"><a href="#3-4-JetPlayer-播放音频" class="headerlink" title="3.4 JetPlayer 播放音频"></a>3.4 JetPlayer 播放音频</h2><p>在Android中，还提供了对Jet播放的支持，Jet是由OHA联盟成员SONiVOX开发的一个交互音乐引擎。其包括两部分：JET播放器和JET引擎。JET常用于控制游戏的声音特效，采用MIDI（Musical Instrument Digital Interface）格式。</p>
<p>MIDI数据有一套音乐符号构成，而非实际的音乐，这些音乐符号的一个序列称为MIDI消息，Jet文件包含多个Jet段，而每个Jet段又包含多个轨迹，一个轨迹是MIDI 消息的一个序列。</p>
<p>JetPlayer类内部有个存放Jet段的队列，JetPlayer类的主要作用就是向队列中添加Jet段或者清空队列，其次就是控制Jet段的轨迹是否处于打开状态。需要注意的是，在Android开发中，JetPlayer是基于单子模式实现的，在整个系统中，仅存在一个JetPlayer的对象。</p>
<p>JetPlayer的常用方法包括：</p>
<pre><code>getJetPlayer()    //获得JetPlayer的句柄
clearQueue()    //清空队列
setEventListener()    //设置JetPlayer.OnJetEventListener监听器
loadJetFile()    //加载Jet文件
queueJetSegment()    //查询Jet段
play()    //播放Jet文件
</code></pre>
<p>以下为.jet文件播放的示例:</p>
<pre><code>    private void startPlay()&#123;
        // 获取JetPlayer播放器
        JetPlayer mJetPlayer = JetPlayer.getJetPlayer() ;
        //清空播放队列
        mJetPlayer.clearQueue() ;
        //绑定事件监听
        mJetPlayer.setEventListener(new JetPlayer.OnJetEventListener() &#123;
            //播放次数记录
            int playNum = 1 ;
            @Override
            public void onJetEvent(JetPlayer player, short segment, byte track, byte channel, byte controller, byte value) &#123;
                Log.i(&quot;york&quot;,&quot;-----&gt;onJetEvent&quot;) ;
            &#125;

            @Override
            public void onJetUserIdUpdate(JetPlayer player, int userId, int repeatCount) &#123;
                Log.i(&quot;york&quot;,&quot;-----&gt;onJetUserIdUpdate&quot;) ;
            &#125;

            @Override
            public void onJetNumQueuedSegmentUpdate(JetPlayer player, int nbSegments) &#123;
                Log.i(&quot;york&quot;,&quot;-----&gt;onJetNumQueuedSegmentUpdate&quot;) ;
            &#125;

            @Override
            public void onJetPauseUpdate(JetPlayer player, int paused) &#123;
                Log.i(&quot;york&quot;,&quot;-----&gt;onJetPauseUpdate&quot;) ;
                if(playNum == 2)&#123;
                    playNum = -1 ;
                    //释放资源，并关闭jet文件
                    player.release();
                    player.closeJetFile() ;
                &#125;else&#123;
                    playNum++ ;
                &#125;
            &#125;
        &#125;);
        //加载资源
        mJetPlayer.loadJetFile(getResources().openRawResourceFd(R.raw.jetaudio)) ;
        byte sSegmentID = 0 ;
        //指定播放序列
        mJetPlayer.queueJetSegment(0, 0, 0, 0, 0, sSegmentID);
        mJetPlayer.queueJetSegment(1, 0, 1, 0, 0, sSegmentID);
        //开始播放
        mJetPlayer.play() ;
    &#125;
</code></pre>
<h2 id="3-5-Ringtone-播放音频"><a href="#3-5-Ringtone-播放音频" class="headerlink" title="3.5 Ringtone 播放音频"></a>3.5 Ringtone 播放音频</h2><p>Ringtone提供了快速播放铃声、通知和其他类似声音的方法。</p>
<p><strong>① Ringtone 实例化</strong></p>
<p>RingtoneManager类提供了Ringtone 的实例化方法：</p>
<pre><code>//通过铃声uri获取
static Ringtone getRingtone(Context context, Uri ringtoneUri)
//通过铃声检索位置获取
Ringtone getRingtone(int position)
</code></pre>
<p><strong>② 重要类 RingtoneManager</strong></p>
<pre><code>// 2个构造方法
RingtoneManager(Activity activity)
RingtoneManager(Context context)

// 获取指定声音类型(铃声、通知、闹铃等)的默认声音的Uri
static Uri getDefaultUri(int type)

// 获取系统所有Ringtone的cursor
Cursor getCursor()

// 获取cursor指定位置的Ringtone uri
Uri getRingtoneUri(int position)

// 判断指定Uri是否为默认铃声
static boolean isDefault(Uri ringtoneUri)

//获取指定uri的所属类型
static int getDefaultType(Uri defaultRingtoneUri)

//将指定Uri设置为指定声音类型的默认声音
static void setActualDefaultRingtoneUri(Context context, int type, Uri ringtoneUri)
</code></pre>
<p><strong>③ Ringtone播放音频示例</strong></p>
<pre><code>/**
 * 播放来电铃声的默认音乐
 **/
private void playRingtoneDefault()&#123;
    Uri uri = RingtoneManager.getDefaultUri(RingtoneManager.TYPE_RINGTONE) ;
    Ringtone mRingtone = RingtoneManager.getRingtone(this,uri);
    mRingtone.play();
&#125;
</code></pre>
<p>ok，以上是Ringtone播放音频的相关介绍</p>
<h2 id="3-6-OpenSL-ES-播放音频"><a href="#3-6-OpenSL-ES-播放音频" class="headerlink" title="3.6 OpenSL ES  播放音频"></a>3.6 OpenSL ES  播放音频</h2><p>在文章的上面内容，已经对OpenSL ES 做了相应介绍。</p>
<p>OpenSL ES 的开发流程主要有如下6个步骤：</p>
<ol>
<li>创建接口对象</li>
<li>设置混音器</li>
<li>创建录音器（播放器）</li>
<li>设置缓冲队列和回调函数</li>
<li>设置播放状态</li>
<li>启动回调函数</li>
</ol>
<p>这里把音频播放部分的代码贴出来，如下：</p>
<p>YorkAudio.cpp</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Created by 86158 on 2019/8/19.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;SLES/OpenSLES.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;YorkAudio.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @param type //0;边录边播；1，播放</span></span><br><span class="line"><span class="comment"> * @param dir</span></span><br><span class="line"><span class="comment"> * @param playstatus</span></span><br><span class="line"><span class="comment"> * @param sample_rate</span></span><br><span class="line"><span class="comment"> * @param chenll</span></span><br><span class="line"><span class="comment"> * @param format</span></span><br><span class="line"><span class="comment"> * @param callJava</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">YorkAudio::YorkAudio(<span class="type">int</span> type, <span class="type">const</span> <span class="type">char</span> *dir, YorkPlaystatus *playstatus, <span class="type">int</span> sample_rate,</span><br><span class="line">                       <span class="type">int</span> channll, <span class="type">int</span> format, PlayCallJava *callJava) &#123;</span><br><span class="line">    this-&gt;AudioType = type;</span><br><span class="line">    this-&gt;playstatus = playstatus;</span><br><span class="line">    this-&gt;callJava = callJava;</span><br><span class="line">    <span class="built_in">queue</span> = new YorkQueue(playstatus);</span><br><span class="line">    this-&gt;sample_rate = sample_rate;</span><br><span class="line">    this-&gt;chenell = channll;</span><br><span class="line">    this-&gt;format = format;</span><br><span class="line">    this-&gt;openSLHelp = new OpenSLHelp();</span><br><span class="line">    pthread_mutex_init(&amp;codecMutex, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">if</span> (dir != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        pcmFile = fopen(dir, <span class="string">&quot;w+&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    buffer = (<span class="type">uint8_t</span> *) av_malloc(sample_rate * <span class="number">2</span> * <span class="number">2</span>);</span><br><span class="line">    sampleBuffer = static_cast&lt;SAMPLETYPE *&gt;(<span class="built_in">malloc</span>(sample_rate * <span class="number">2</span> * <span class="number">2</span>));</span><br><span class="line">    soundTouch = new SoundTouch();</span><br><span class="line">    soundTouch-&gt;setSampleRate(sample_rate);</span><br><span class="line">    soundTouch-&gt;setChannels(chenell);</span><br><span class="line">    soundTouch-&gt;setPitch(pitch);</span><br><span class="line">    soundTouch-&gt;setTempo(speed);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">YorkAudio::~YorkAudio() &#123;</span><br><span class="line">    pthread_mutex_destroy(&amp;codecMutex);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">YorkAudio::resampleAudio</span><span class="params">(<span class="type">void</span> **pcmbuf)</span> &#123;</span><br><span class="line">    data_size = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (playstatus != <span class="literal">NULL</span> &amp;&amp; !playstatus-&gt;<span class="built_in">exit</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (playstatus-&gt;seek) &#123;</span><br><span class="line">            av_usleep(<span class="number">1000</span> * <span class="number">100</span>);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (AudioType == <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">queue</span>-&gt;getQueueSize() == <span class="number">0</span>) &#123;<span class="comment">//加载中</span></span><br><span class="line">                <span class="keyword">if</span> (!playstatus-&gt;load) &#123;</span><br><span class="line">                    playstatus-&gt;load = <span class="literal">true</span>;</span><br><span class="line">                    callJava-&gt;onCallOnLoad(CHILD_THREAD, <span class="literal">true</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                av_usleep(<span class="number">1000</span> * <span class="number">100</span>);</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (playstatus-&gt;load) &#123;</span><br><span class="line">                    playstatus-&gt;load = <span class="literal">false</span>;</span><br><span class="line">                    callJava-&gt;onCallOnLoad(CHILD_THREAD, <span class="literal">false</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (readFrameFinshed) &#123;</span><br><span class="line">                avPacket = av_packet_alloc();</span><br><span class="line">                <span class="keyword">if</span> (<span class="built_in">queue</span>-&gt;getAvpacket(avPacket) != <span class="number">0</span>) &#123;</span><br><span class="line">                    av_packet_free(&amp;avPacket);</span><br><span class="line">                    av_free(avPacket);</span><br><span class="line">                    avPacket = <span class="literal">NULL</span>;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                pthread_mutex_lock(&amp;codecMutex);</span><br><span class="line">                <span class="comment">//avPacket放入avCodecContext</span></span><br><span class="line">                ret = avcodec_send_packet(avCodecContext, avPacket);</span><br><span class="line">                <span class="keyword">if</span> (ret != <span class="number">0</span>) &#123;</span><br><span class="line">                    av_packet_free(&amp;avPacket);</span><br><span class="line">                    av_free(avPacket);</span><br><span class="line">                    avPacket = <span class="literal">NULL</span>;</span><br><span class="line">                    pthread_mutex_unlock(&amp;codecMutex);</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            avFrame = av_frame_alloc();</span><br><span class="line">            <span class="comment">//avFrame就是解码出来 在avCodecContext里的音频帧</span></span><br><span class="line">            ret = avcodec_receive_frame(avCodecContext, avFrame);</span><br><span class="line">            <span class="keyword">if</span> (ret == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (avFrame-&gt;channels &amp;&amp; avFrame-&gt;channel_layout == <span class="number">0</span>) &#123;</span><br><span class="line">                    avFrame-&gt;channel_layout = av_get_default_channel_layout(avFrame-&gt;channels);</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (avFrame-&gt;channels == <span class="number">0</span> &amp;&amp; avFrame-&gt;channel_layout &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                    avFrame-&gt;channels = av_get_channel_layout_nb_channels(avFrame-&gt;channel_layout);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">//设置重采样的上下文</span></span><br><span class="line">                SwrContext *swr_ctx;</span><br><span class="line">                swr_ctx = swr_alloc_set_opts(</span><br><span class="line">                        <span class="literal">NULL</span>,</span><br><span class="line">                        SL_SPEAKER_FRONT_LEFT | SL_SPEAKER_FRONT_RIGHT,</span><br><span class="line">                        AV_SAMPLE_FMT_S16,<span class="comment">//很奇怪，用其他的会炸裂</span></span><br><span class="line">                        avFrame-&gt;sample_rate,</span><br><span class="line">                        avFrame-&gt;channel_layout,</span><br><span class="line">                        (AVSampleFormat) avFrame-&gt;format,</span><br><span class="line">                        avFrame-&gt;sample_rate, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line">                <span class="keyword">if</span> (!swr_ctx || swr_init(swr_ctx) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                    av_packet_free(&amp;avPacket);</span><br><span class="line">                    av_free(avPacket);</span><br><span class="line">                    avPacket = <span class="literal">NULL</span>;</span><br><span class="line">                    av_frame_free(&amp;avFrame);</span><br><span class="line">                    av_free(avFrame);</span><br><span class="line">                    avFrame = <span class="literal">NULL</span>;</span><br><span class="line">                    <span class="keyword">if</span> (swr_ctx != <span class="literal">NULL</span>) &#123;</span><br><span class="line">                        swr_free(&amp;swr_ctx);</span><br><span class="line">                        swr_ctx = <span class="literal">NULL</span>;</span><br><span class="line">                        pthread_mutex_unlock(&amp;codecMutex);</span><br><span class="line">                    &#125;</span><br><span class="line">                    readFrameFinshed = <span class="literal">true</span>;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//重采样函数swr_convert();</span></span><br><span class="line">                nb = swr_convert(</span><br><span class="line">                        swr_ctx,</span><br><span class="line">                        &amp;buffer,</span><br><span class="line">                        avFrame-&gt;nb_samples,</span><br><span class="line">                        (<span class="type">const</span> <span class="type">uint8_t</span> **) (avFrame-&gt;data),</span><br><span class="line">                        avFrame-&gt;nb_samples);</span><br><span class="line">                <span class="type">int</span> out_channels = av_get_channel_layout_nb_channels(AV_CH_LAYOUT_STEREO);</span><br><span class="line">                data_size = nb * out_channels * av_get_bytes_per_sample(AV_SAMPLE_FMT_S16);</span><br><span class="line">                now_time = avFrame-&gt;pts * av_q2d(time_base);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (now_time &lt; audio_clock) &#123;</span><br><span class="line">                    now_time = audio_clock;</span><br><span class="line">                &#125;</span><br><span class="line">                audio_clock = now_time;</span><br><span class="line">                *pcmbuf = buffer;</span><br><span class="line">                av_frame_free(&amp;avFrame);</span><br><span class="line">                av_free(avFrame);</span><br><span class="line">                avFrame = <span class="literal">NULL</span>;</span><br><span class="line">                swr_free(&amp;swr_ctx);</span><br><span class="line">                pthread_mutex_unlock(&amp;codecMutex);</span><br><span class="line">                swr_ctx = <span class="literal">NULL</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                av_packet_free(&amp;avPacket);</span><br><span class="line">                av_free(avPacket);</span><br><span class="line">                avPacket = <span class="literal">NULL</span>;</span><br><span class="line">                av_frame_free(&amp;avFrame);</span><br><span class="line">                av_free(avFrame);</span><br><span class="line">                avFrame = <span class="literal">NULL</span>;</span><br><span class="line">                pthread_mutex_unlock(&amp;codecMutex);</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> data_size;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">pcmBufferPlayCallBack</span><span class="params">(SLAndroidSimpleBufferQueueItf bf, <span class="type">void</span> *context)</span> &#123;</span><br><span class="line">    YorkAudio *yorkAudio = (YorkAudio *) context;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (yorkAudio != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (yorkAudio-&gt;chenell==<span class="number">2</span>)&#123;<span class="comment">//只有是立体声的才进行左右声道拆分</span></span><br><span class="line">            <span class="type">int</span> buffersize = yorkAudio-&gt;getSoundTouchData();</span><br><span class="line">            <span class="keyword">if</span> (buffersize &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                yorkAudio-&gt;audio_clock += buffersize / ((<span class="type">double</span>) ((yorkAudio-&gt;sample_rate * <span class="number">2</span> * <span class="number">2</span>)));</span><br><span class="line">                <span class="keyword">if</span> (yorkAudio-&gt;AudioType == <span class="number">1</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (yorkAudio-&gt;audio_clock - yorkAudio-&gt;last_time_change &gt;= <span class="number">0.0001</span>) &#123;</span><br><span class="line">                        yorkAudio-&gt;last_time_change = yorkAudio-&gt;audio_clock;</span><br><span class="line">                    &#125;</span><br><span class="line">                    yorkAudio-&gt;callJava-&gt;onCallPlayData(CHILD_THREAD, yorkAudio-&gt;chenell,</span><br><span class="line">                                                        yorkAudio-&gt;sampleBuffer, buffersize * <span class="number">4</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                (*yorkAudio-&gt;openSLHelp-&gt;queueInterface)-&gt;Enqueue(</span><br><span class="line">                        yorkAudio-&gt;openSLHelp-&gt;queueInterface, (<span class="type">char</span> *) yorkAudio-&gt;sampleBuffer,</span><br><span class="line">                        buffersize * <span class="number">4</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="type">double</span> buffersize = yorkAudio-&gt;resampleAudio(reinterpret_cast&lt;<span class="type">void</span> **&gt;(&amp;yorkAudio-&gt;out_buffer));</span><br><span class="line">            <span class="keyword">if</span> (buffersize &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                yorkAudio-&gt;audio_clock += buffersize / ((<span class="type">double</span>) ((yorkAudio-&gt;sample_rate * <span class="number">2</span> * <span class="number">2</span>)));</span><br><span class="line">                <span class="keyword">if</span> (yorkAudio-&gt;AudioType == <span class="number">1</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (yorkAudio-&gt;audio_clock - yorkAudio-&gt;last_time_change &gt;= <span class="number">0.0001</span>) &#123;</span><br><span class="line">                        yorkAudio-&gt;last_time_change = yorkAudio-&gt;audio_clock;</span><br><span class="line">                    &#125;</span><br><span class="line">                    yorkAudio-&gt;callJava-&gt;onCallPlayData(CHILD_THREAD, yorkAudio-&gt;chenell,</span><br><span class="line">                                                        yorkAudio-&gt;buffer, buffersize);</span><br><span class="line">                &#125;</span><br><span class="line">                (*yorkAudio-&gt;openSLHelp-&gt;queueInterface)-&gt;Enqueue(</span><br><span class="line">                        yorkAudio-&gt;openSLHelp-&gt;queueInterface, (<span class="type">char</span> *) yorkAudio-&gt;buffer,</span><br><span class="line">                        buffersize);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">YorkAudio::resampleAudioToPCM</span><span class="params">()</span> &#123;</span><br><span class="line">    data_size = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (playstatus != <span class="literal">NULL</span> &amp;&amp; playstatus-&gt;codec) &#123;</span><br><span class="line">        avPacket = av_packet_alloc();</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">queue</span>-&gt;getAvpacket(avPacket) != <span class="number">0</span>) &#123;</span><br><span class="line">            av_packet_free(&amp;avPacket);</span><br><span class="line">            av_free(avPacket);</span><br><span class="line">            avPacket = <span class="literal">NULL</span>;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        ret = avcodec_send_packet(avCodecContext, avPacket);</span><br><span class="line">        <span class="keyword">if</span> (ret != <span class="number">0</span>) &#123;</span><br><span class="line">            av_packet_free(&amp;avPacket);</span><br><span class="line">            av_free(avPacket);</span><br><span class="line">            avPacket = <span class="literal">NULL</span>;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        avFrame = av_frame_alloc();</span><br><span class="line">        ret = avcodec_receive_frame(avCodecContext, avFrame);</span><br><span class="line">        <span class="keyword">if</span> (ret == <span class="number">0</span>) &#123;</span><br><span class="line">            readFrameFinshed = <span class="literal">false</span>;</span><br><span class="line">            <span class="keyword">if</span> (avFrame-&gt;channels &amp;&amp; avFrame-&gt;channel_layout == <span class="number">0</span>) &#123;</span><br><span class="line">                avFrame-&gt;channel_layout = av_get_default_channel_layout(avFrame-&gt;channels);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (avFrame-&gt;channels == <span class="number">0</span> &amp;&amp; avFrame-&gt;channel_layout &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                avFrame-&gt;channels = av_get_channel_layout_nb_channels(avFrame-&gt;channel_layout);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//设置重采样的上下文</span></span><br><span class="line">            SwrContext *swr_ctx;</span><br><span class="line">            swr_ctx = swr_alloc_set_opts(</span><br><span class="line">                    <span class="literal">NULL</span>,</span><br><span class="line">                    SL_SPEAKER_FRONT_LEFT | SL_SPEAKER_FRONT_RIGHT,</span><br><span class="line">                    AV_SAMPLE_FMT_S16,</span><br><span class="line">                    avFrame-&gt;sample_rate,</span><br><span class="line">                    avFrame-&gt;channel_layout,</span><br><span class="line">                    (AVSampleFormat) avFrame-&gt;format,</span><br><span class="line">                    avFrame-&gt;sample_rate, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line">            <span class="keyword">if</span> (!swr_ctx || swr_init(swr_ctx) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                av_packet_free(&amp;avPacket);</span><br><span class="line">                av_free(avPacket);</span><br><span class="line">                avPacket = <span class="literal">NULL</span>;</span><br><span class="line">                av_frame_free(&amp;avFrame);</span><br><span class="line">                av_free(avFrame);</span><br><span class="line">                avFrame = <span class="literal">NULL</span>;</span><br><span class="line">                <span class="keyword">if</span> (swr_ctx != <span class="literal">NULL</span>) &#123;</span><br><span class="line">                    swr_free(&amp;swr_ctx);</span><br><span class="line">                    swr_ctx = <span class="literal">NULL</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            nb = swr_convert(</span><br><span class="line">                    swr_ctx,</span><br><span class="line">                    &amp;buffer,</span><br><span class="line">                    avFrame-&gt;nb_samples,</span><br><span class="line">                    (<span class="type">const</span> <span class="type">uint8_t</span> **) (avFrame-&gt;data),</span><br><span class="line">                    avFrame-&gt;nb_samples);</span><br><span class="line">            <span class="type">int</span> out_channels = av_get_channel_layout_nb_channels(AV_CH_LAYOUT_STEREO);</span><br><span class="line">            data_size = nb * out_channels * av_get_bytes_per_sample(AV_SAMPLE_FMT_S16);</span><br><span class="line">            fwrite(buffer, <span class="number">1</span>, data_size, pcmFile);</span><br><span class="line">            decodenow = avFrame-&gt;pts * av_q2d(time_base);</span><br><span class="line">            <span class="keyword">if</span> (callJava != <span class="literal">NULL</span>) &#123;</span><br><span class="line">                callJava-&gt;onCallDecodePosition(CHILD_THREAD, decodenow / (audio_duration * <span class="number">1.0</span>));</span><br><span class="line">            &#125;</span><br><span class="line">            av_packet_free(&amp;avPacket);</span><br><span class="line">            av_free(avPacket);</span><br><span class="line">            avPacket = <span class="literal">NULL</span>;</span><br><span class="line">            av_frame_free(&amp;avFrame);</span><br><span class="line">            av_free(avFrame);</span><br><span class="line">            avFrame = <span class="literal">NULL</span>;</span><br><span class="line">            swr_free(&amp;swr_ctx);</span><br><span class="line">            swr_ctx = <span class="literal">NULL</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            readFrameFinshed = <span class="literal">true</span>;</span><br><span class="line">            av_packet_free(&amp;avPacket);</span><br><span class="line">            av_free(avPacket);</span><br><span class="line">            avPacket = <span class="literal">NULL</span>;</span><br><span class="line">            av_frame_free(&amp;avFrame);</span><br><span class="line">            av_free(avFrame);</span><br><span class="line">            avFrame = <span class="literal">NULL</span>;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">queue</span>-&gt;getQueueSize() == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    fclose(pcmFile);</span><br><span class="line">    <span class="keyword">if</span> (LOG_DEBUG) &#123;</span><br><span class="line">        LOGD(<span class="string">&quot;resample and pcm save finish ! &quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (callJava != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        callJava-&gt;onPCMdown(CHILD_THREAD);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> data_size;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> *<span class="title function_">decodePlay</span><span class="params">(<span class="type">void</span> *data)</span> &#123;</span><br><span class="line"></span><br><span class="line">    YorkAudio *yorkAudio = (YorkAudio *) data;</span><br><span class="line">    yorkAudio-&gt;playOpenSLES();</span><br><span class="line">    pthread_exit(&amp;yorkAudio-&gt;thread_play);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> *<span class="title function_">decodc</span><span class="params">(<span class="type">void</span> *data)</span> &#123;</span><br><span class="line"></span><br><span class="line">    YorkAudio *yorkAudio = (YorkAudio *) data;</span><br><span class="line">    yorkAudio-&gt;resampleAudioToPCM();</span><br><span class="line">    pthread_exit(&amp;yorkAudio-&gt;thread_codec);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">YorkAudio::codec</span><span class="params">()</span> &#123;</span><br><span class="line">    pthread_create(&amp;thread_codec, <span class="literal">NULL</span>, decodc, this);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">YorkAudio::playOpenSLES</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">//1.初始化openSL</span></span><br><span class="line">    openSLHelp-&gt;openSLHelperInit();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//2,创建混音器</span></span><br><span class="line">    <span class="type">const</span> SLInterfaceID mids[<span class="number">1</span>] = &#123;SL_IID_ENVIRONMENTALREVERB&#125;;</span><br><span class="line">    <span class="type">const</span> SLboolean mreq[<span class="number">1</span>] = &#123;SL_BOOLEAN_FALSE&#125;;</span><br><span class="line">    (*openSLHelp-&gt;engineInterface)-&gt;CreateOutputMix(openSLHelp-&gt;engineInterface,</span><br><span class="line">                                                    &amp;openSLHelp-&gt;outputMixObject, <span class="number">1</span>, mids, mreq);</span><br><span class="line"></span><br><span class="line">    (*openSLHelp-&gt;outputMixObject)-&gt;Realize(openSLHelp-&gt;outputMixObject, SL_BOOLEAN_FALSE);</span><br><span class="line"></span><br><span class="line">    (*openSLHelp-&gt;outputMixObject)-&gt;GetInterface(openSLHelp-&gt;outputMixObject,</span><br><span class="line">                                                 SL_IID_ENVIRONMENTALREVERB,</span><br><span class="line">                                                 &amp;openSLHelp-&gt;outputMixEnvironmentalReverb);</span><br><span class="line">    (*openSLHelp-&gt;outputMixEnvironmentalReverb)-&gt;SetEnvironmentalReverbProperties(</span><br><span class="line">            openSLHelp-&gt;outputMixEnvironmentalReverb, &amp;openSLHelp-&gt;reverbSettings);</span><br><span class="line">    openSLHelp-&gt;outputMix = &#123;SL_DATALOCATOR_OUTPUTMIX, openSLHelp-&gt;outputMixObject&#125;;</span><br><span class="line">    openSLHelp-&gt;sink = &#123;&amp;openSLHelp-&gt;outputMix, <span class="number">0</span>&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//3，配置PCM格式信息</span></span><br><span class="line"></span><br><span class="line">    openSLHelp-&gt;android_queue = &#123;SL_DATALOCATOR_ANDROIDSIMPLEBUFFERQUEUE, <span class="number">2</span>&#125;;</span><br><span class="line"></span><br><span class="line">    openSLHelp-&gt;formatPCM = &#123;</span><br><span class="line">            SL_DATAFORMAT_PCM,<span class="comment">//播放pcm格式的数据</span></span><br><span class="line">            <span class="number">2</span>,<span class="comment">//2个声道（立体声）</span></span><br><span class="line">            openSLHelp-&gt;getCurrentSampleRateForOpensles(sample_rate),<span class="comment">//44100hz的频率</span></span><br><span class="line">            SL_PCMSAMPLEFORMAT_FIXED_16,<span class="comment">//位数 16位</span></span><br><span class="line">            SL_PCMSAMPLEFORMAT_FIXED_16,<span class="comment">//和位数一致就行</span></span><br><span class="line">            SL_SPEAKER_FRONT_LEFT | SL_SPEAKER_FRONT_RIGHT,<span class="comment">//立体声（前左前右）</span></span><br><span class="line">            SL_BYTEORDER_LITTLEENDIAN<span class="comment">//结束标志</span></span><br><span class="line">    &#125;;</span><br><span class="line">    openSLHelp-&gt;source = &#123;&amp;openSLHelp-&gt;android_queue, &amp;openSLHelp-&gt;formatPCM&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="type">const</span> SLInterfaceID ids[<span class="number">4</span>] = &#123;SL_IID_BUFFERQUEUE, SL_IID_VOLUME, SL_IID_PLAYBACKRATE,</span><br><span class="line">                                  SL_IID_MUTESOLO&#125;;</span><br><span class="line">    <span class="type">const</span> SLboolean req[<span class="number">4</span>] = &#123;SL_BOOLEAN_TRUE, SL_BOOLEAN_TRUE, SL_BOOLEAN_TRUE, SL_BOOLEAN_TRUE&#125;;</span><br><span class="line"></span><br><span class="line">    (*openSLHelp-&gt;engineInterface)-&gt;CreateAudioPlayer(</span><br><span class="line">            openSLHelp-&gt;engineInterface,</span><br><span class="line">            &amp;openSLHelp-&gt;playerObject,</span><br><span class="line">            &amp;openSLHelp-&gt;source,</span><br><span class="line">            &amp;openSLHelp-&gt;sink,</span><br><span class="line">            <span class="number">4</span>,</span><br><span class="line">            ids, req);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//4. 初始化播放器</span></span><br><span class="line">    (*openSLHelp-&gt;playerObject)-&gt;Realize(openSLHelp-&gt;playerObject, SL_BOOLEAN_FALSE);</span><br><span class="line"></span><br><span class="line">    (*openSLHelp-&gt;playerObject)-&gt;GetInterface(openSLHelp-&gt;playerObject, SL_IID_PLAY,</span><br><span class="line">                                              &amp;openSLHelp-&gt;playInterface);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//获取声音接口</span></span><br><span class="line">    (*openSLHelp-&gt;playerObject)-&gt;GetInterface(openSLHelp-&gt;playerObject, SL_IID_VOLUME,</span><br><span class="line">                                              &amp;openSLHelp-&gt;pcmVolumePlay);</span><br><span class="line">    <span class="comment">//获取声道接口</span></span><br><span class="line">    (*openSLHelp-&gt;playerObject)-&gt;GetInterface(openSLHelp-&gt;playerObject, SL_IID_MUTESOLO,</span><br><span class="line">                                              &amp;openSLHelp-&gt;pcmMutePlay);</span><br><span class="line"></span><br><span class="line">    (*openSLHelp-&gt;playerObject)-&gt;GetInterface(openSLHelp-&gt;playerObject, SL_IID_BUFFERQUEUE,</span><br><span class="line">                                              &amp;openSLHelp-&gt;queueInterface);</span><br><span class="line">    (*openSLHelp-&gt;queueInterface)-&gt;RegisterCallback(openSLHelp-&gt;queueInterface,</span><br><span class="line">                                                    pcmBufferPlayCallBack, this);</span><br><span class="line">    (*openSLHelp-&gt;playInterface)-&gt;SetPlayState(openSLHelp-&gt;playInterface, SL_PLAYSTATE_PLAYING);</span><br><span class="line">    pcmBufferPlayCallBack(openSLHelp-&gt;queueInterface, this);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">YorkAudio::playAudio</span><span class="params">()</span> &#123;</span><br><span class="line">    pthread_create(&amp;thread_play, <span class="literal">NULL</span>, decodePlay, this);</span><br><span class="line">    <span class="keyword">if</span> (LOG_DEBUG) &#123;</span><br><span class="line">        LOGD(<span class="string">&quot;player start ...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">YorkAudio::pauseAudio</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (openSLHelp != <span class="literal">NULL</span> &amp;&amp; openSLHelp-&gt;playInterface != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        (*openSLHelp-&gt;playInterface)-&gt;SetPlayState(openSLHelp-&gt;playInterface, SL_PLAYSTATE_PAUSED);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (LOG_DEBUG) &#123;</span><br><span class="line">        LOGD(<span class="string">&quot;player paused ...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">YorkAudio::resumeAudio</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (openSLHelp != <span class="literal">NULL</span> &amp;&amp; openSLHelp-&gt;playInterface != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        (*openSLHelp-&gt;playInterface)-&gt;SetPlayState(openSLHelp-&gt;playInterface, SL_PLAYSTATE_PLAYING);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (LOG_DEBUG) &#123;</span><br><span class="line">        LOGD(<span class="string">&quot;player resumed ...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">YorkAudio::releaseAudio</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">queue</span> != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        delete (<span class="built_in">queue</span>);</span><br><span class="line">        <span class="built_in">queue</span> = <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (buffer != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="built_in">free</span>(buffer);</span><br><span class="line">        buffer = <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (soundTouch == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        delete soundTouch;</span><br><span class="line">        soundTouch = <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (openSLHelp != <span class="literal">NULL</span> &amp;&amp; openSLHelp-&gt;playInterface != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        (*openSLHelp-&gt;playInterface)-&gt;SetPlayState(openSLHelp-&gt;playInterface, SL_PLAYSTATE_STOPPED);</span><br><span class="line">        openSLHelp-&gt;playDestroy();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (avCodecContext != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        avcodec_close(avCodecContext);</span><br><span class="line">        avcodec_free_context(&amp;avCodecContext);</span><br><span class="line">        avCodecContext = <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (callJava != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        callJava = <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">YorkAudio::getDB</span><span class="params">(<span class="type">int16_t</span> *pcmdata, <span class="type">size_t</span> pcmsize, <span class="type">int</span> chenell, <span class="type">int</span> format,</span></span><br><span class="line"><span class="params">                       PlayCallJava *calljava)</span> &#123;</span><br><span class="line">    <span class="type">int</span> db = <span class="number">0</span>;</span><br><span class="line">    <span class="type">int</span> db_left = <span class="number">0</span>;</span><br><span class="line">    <span class="type">int</span> db_right = <span class="number">0</span>;</span><br><span class="line">    <span class="type">double</span> sum = <span class="number">0</span>;</span><br><span class="line">    <span class="type">double</span> sum_left = <span class="number">0</span>;</span><br><span class="line">    <span class="type">double</span> sum_right = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (chenell == <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="type">short</span> pervalue = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; pcmsize; i += <span class="number">12</span>) &#123;</span><br><span class="line">            <span class="built_in">memcpy</span>(&amp;pervalue, pcmdata + i, <span class="number">2</span>);</span><br><span class="line">            sum += <span class="built_in">abs</span>(pervalue);</span><br><span class="line">        &#125;</span><br><span class="line">        sum = sum / (pcmsize / <span class="number">12</span>);</span><br><span class="line">        <span class="keyword">if</span> (sum &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            db = (<span class="type">int</span>) <span class="number">20.0</span> * <span class="built_in">log10</span>(sum);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="type">int32_t</span> pervalue = <span class="number">0</span>;</span><br><span class="line">        <span class="type">short</span> per_left = <span class="number">0</span>;</span><br><span class="line">        <span class="type">short</span> per_right = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; pcmsize; i += <span class="number">12</span>) &#123;</span><br><span class="line">            <span class="built_in">memcpy</span>(&amp;pervalue, pcmdata + i, <span class="number">4</span>);</span><br><span class="line">            <span class="built_in">memcpy</span>(&amp;per_left, pcmdata + i, <span class="number">2</span>);</span><br><span class="line">            <span class="built_in">memcpy</span>(&amp;per_right, pcmdata + i + <span class="number">2</span>, <span class="number">2</span>);</span><br><span class="line">            sum += <span class="built_in">abs</span>(pervalue);</span><br><span class="line">            sum_left += <span class="built_in">abs</span>(per_left);</span><br><span class="line">            sum_right += <span class="built_in">abs</span>(per_right);</span><br><span class="line">        &#125;</span><br><span class="line">        sum = sum / (pcmsize / <span class="number">12</span>);</span><br><span class="line">        sum_left = sum_left / (pcmsize / <span class="number">12</span>);</span><br><span class="line">        sum_right = sum_right / (pcmsize / <span class="number">12</span>);</span><br><span class="line">        <span class="keyword">if</span> (sum &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            db = (<span class="type">int</span>) <span class="number">20.0</span> * <span class="built_in">log10</span>(sum);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (sum_right &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            db_right = (<span class="type">int</span>) <span class="number">20.0</span> * <span class="built_in">log10</span>(sum_right);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (sum_left &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            db_left = (<span class="type">int</span>) <span class="number">20.0</span> * <span class="built_in">log10</span>(sum_left);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (calljava != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        calljava-&gt;onCallPlayerDB(CHILD_THREAD, chenell, db, db_left, db_right);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">YorkAudio::getPlayStates</span><span class="params">()</span> &#123;</span><br><span class="line">    SLuint32 state = <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">if</span> (openSLHelp != <span class="literal">NULL</span> &amp;&amp; openSLHelp-&gt;playInterface != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        (*openSLHelp-&gt;playInterface)-&gt;GetPlayState(openSLHelp-&gt;playInterface, &amp;state);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> state;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">YorkAudio::setVolume</span><span class="params">(<span class="type">int</span> percent)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (openSLHelp-&gt;pcmVolumePlay != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (percent &gt; <span class="number">30</span>) &#123;</span><br><span class="line">            (*openSLHelp-&gt;pcmVolumePlay)-&gt;SetVolumeLevel(openSLHelp-&gt;pcmVolumePlay,</span><br><span class="line">                                                         (<span class="number">100</span> - percent) * <span class="number">-20</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (percent &gt; <span class="number">25</span>) &#123;</span><br><span class="line">            (*openSLHelp-&gt;pcmVolumePlay)-&gt;SetVolumeLevel(openSLHelp-&gt;pcmVolumePlay,</span><br><span class="line">                                                         (<span class="number">100</span> - percent) * <span class="number">-22</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (percent &gt; <span class="number">20</span>) &#123;</span><br><span class="line">            (*openSLHelp-&gt;pcmVolumePlay)-&gt;SetVolumeLevel(openSLHelp-&gt;pcmVolumePlay,</span><br><span class="line">                                                         (<span class="number">100</span> - percent) * <span class="number">-25</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (percent &gt; <span class="number">15</span>) &#123;</span><br><span class="line">            (*openSLHelp-&gt;pcmVolumePlay)-&gt;SetVolumeLevel(openSLHelp-&gt;pcmVolumePlay,</span><br><span class="line">                                                         (<span class="number">100</span> - percent) * <span class="number">-28</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (percent &gt; <span class="number">10</span>) &#123;</span><br><span class="line">            (*openSLHelp-&gt;pcmVolumePlay)-&gt;SetVolumeLevel(openSLHelp-&gt;pcmVolumePlay,</span><br><span class="line">                                                         (<span class="number">100</span> - percent) * <span class="number">-30</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (percent &gt; <span class="number">5</span>) &#123;</span><br><span class="line">            (*openSLHelp-&gt;pcmVolumePlay)-&gt;SetVolumeLevel(openSLHelp-&gt;pcmVolumePlay,</span><br><span class="line">                                                         (<span class="number">100</span> - percent) * <span class="number">-34</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (percent &gt; <span class="number">3</span>) &#123;</span><br><span class="line">            (*openSLHelp-&gt;pcmVolumePlay)-&gt;SetVolumeLevel(openSLHelp-&gt;pcmVolumePlay,</span><br><span class="line">                                                         (<span class="number">100</span> - percent) * <span class="number">-37</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (percent &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            (*openSLHelp-&gt;pcmVolumePlay)-&gt;SetVolumeLevel(openSLHelp-&gt;pcmVolumePlay,</span><br><span class="line">                                                         (<span class="number">100</span> - percent) * <span class="number">-40</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            (*openSLHelp-&gt;pcmVolumePlay)-&gt;SetVolumeLevel(openSLHelp-&gt;pcmVolumePlay,</span><br><span class="line">                                                         (<span class="number">100</span> - percent) * <span class="number">-100</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">YorkAudio::setMute</span><span class="params">(<span class="type">int</span> mute)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (LOG_DEBUG != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        LOGD(<span class="string">&quot;setMute-&gt; mute=%d&quot;</span>, mute)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (openSLHelp-&gt;pcmMutePlay != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (mute == <span class="number">0</span>)<span class="comment">//left</span></span><br><span class="line">        &#123;</span><br><span class="line">            (*openSLHelp-&gt;pcmMutePlay)-&gt;SetChannelMute(openSLHelp-&gt;pcmMutePlay, <span class="number">1</span>, <span class="literal">true</span>);</span><br><span class="line">            (*openSLHelp-&gt;pcmMutePlay)-&gt;SetChannelMute(openSLHelp-&gt;pcmMutePlay, <span class="number">0</span>, <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mute == <span class="number">1</span>)<span class="comment">//right</span></span><br><span class="line">        &#123;</span><br><span class="line">            (*openSLHelp-&gt;pcmMutePlay)-&gt;SetChannelMute(openSLHelp-&gt;pcmMutePlay, <span class="number">1</span>, <span class="literal">false</span>);</span><br><span class="line">            (*openSLHelp-&gt;pcmMutePlay)-&gt;SetChannelMute(openSLHelp-&gt;pcmMutePlay, <span class="number">0</span>, <span class="literal">true</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mute == <span class="number">2</span>)<span class="comment">//center</span></span><br><span class="line">        &#123;</span><br><span class="line">            (*openSLHelp-&gt;pcmMutePlay)-&gt;SetChannelMute(openSLHelp-&gt;pcmMutePlay, <span class="number">1</span>, <span class="literal">false</span>);</span><br><span class="line">            (*openSLHelp-&gt;pcmMutePlay)-&gt;SetChannelMute(openSLHelp-&gt;pcmMutePlay, <span class="number">0</span>, <span class="literal">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">YorkAudio::setPitch</span><span class="params">(<span class="type">float</span> pitch)</span> &#123;</span><br><span class="line">    this-&gt;pitch = pitch;</span><br><span class="line">    <span class="keyword">if</span> (LOG_DEBUG != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        LOGD(<span class="string">&quot;setPitch-&gt; pitch=%f&quot;</span>, pitch)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (soundTouch != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        soundTouch-&gt;setPitchOctaves(pitch);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">YorkAudio::setSpeed</span><span class="params">(<span class="type">float</span> speed)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (speed &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        this-&gt;speed = speed;</span><br><span class="line">        <span class="keyword">if</span> (LOG_DEBUG != <span class="literal">NULL</span>) &#123;</span><br><span class="line">            LOGD(<span class="string">&quot;setSpeed-&gt; speed=%f&quot;</span>, speed)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (soundTouch != <span class="literal">NULL</span>) &#123;</span><br><span class="line">            soundTouch-&gt;setTempo(speed);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">YorkAudio::getSoundTouchData</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">while</span> (playstatus != <span class="literal">NULL</span> &amp;&amp; !playstatus-&gt;<span class="built_in">exit</span>) &#123;</span><br><span class="line">        out_buffer = <span class="literal">NULL</span>;</span><br><span class="line">        <span class="keyword">if</span> (finished) &#123;</span><br><span class="line">            finished = <span class="literal">false</span>;</span><br><span class="line">            data_size = resampleAudio(reinterpret_cast&lt;<span class="type">void</span> **&gt;(&amp;out_buffer));</span><br><span class="line">            <span class="keyword">if</span> (data_size &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; data_size / <span class="number">2</span> + <span class="number">1</span>; i++) &#123;</span><br><span class="line">                    sampleBuffer[i] = (out_buffer[i * <span class="number">2</span>] | ((out_buffer[i * <span class="number">2</span> + <span class="number">1</span>]) &lt;&lt; <span class="number">8</span>));</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                soundTouch-&gt;putSamples(sampleBuffer, nb);</span><br><span class="line">                num = soundTouch-&gt;receiveSamples(sampleBuffer, data_size / <span class="number">4</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                soundTouch-&gt;flush();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (num == <span class="number">0</span>) &#123;</span><br><span class="line">            finished = <span class="literal">true</span>;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (out_buffer == <span class="literal">NULL</span>) &#123;</span><br><span class="line">                num = soundTouch-&gt;receiveSamples(sampleBuffer, data_size / <span class="number">4</span>);</span><br><span class="line">                <span class="keyword">if</span> (num == <span class="number">0</span>) &#123;</span><br><span class="line">                    finished = <span class="literal">true</span>;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> num;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><em>以上就是我对安卓音频模块的整理。有不足之处或是有好建议可以留言找我。</em></p>

        </div>

        
        <section class="post-tags">
            <div>
                <span>Tag(s):</span>
                <span class="tag">
                    
                    
                        <a href="/tags/%E9%9F%B3%E8%A7%86%E9%A2%91/"># 音视频</a>
                    
                        
                </span>
            </div>
            <div>
                <a href="javascript:window.history.back();">back</a>
                <span>· </span>
                <a href="/">home</a>
            </div>
        </section>
        <section class="post-nav">
            
                <a class="prev" rel="prev" href="/2019/08/20/%E5%AE%89%E5%8D%93%E9%9F%B3%E8%A7%86%E9%A2%91%E2%80%94%E2%80%94%E7%BC%96%E8%A7%A3%E7%A0%81/">安卓音视频——编解码</a>
            
            
            <a class="next" rel="next" href="/2019/08/14/%E5%AE%89%E5%8D%93%E9%9F%B3%E8%A7%86%E9%A2%91%E2%80%94%E2%80%94%E5%9F%BA%E7%A1%80%E7%AF%87/">安卓音视频</a>
            
        </section>


    </article>
</div>

            </div>
            <footer id="footer" class="footer">
    <div class="copyright">
        <span>Copyright © 2019 - 2023 Designed by York</span>
    </div>
</footer>

    </div>
</body>

</html>