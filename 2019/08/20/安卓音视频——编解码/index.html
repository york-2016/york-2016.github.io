<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
<meta name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">

    <meta name="author" content="York">





<title>安卓音视频——编解码 | York&#39;s blog</title>



    <link rel="icon" href="/favicon.ico">




    <!-- stylesheets list from _config.yml -->
    
    <link rel="stylesheet" href="/css/style.css">
    



    <!-- scripts list from _config.yml -->
    
    <script src="/js/script.js"></script>
    
    <script src="/js/tocbot.min.js"></script>
    



    
    
        
    


<meta name="generator" content="Hexo 6.3.0"></head>

<body>
    <script>
        // this function is used to check current theme before page loaded.
        (() => {
            const currentTheme = window.localStorage && window.localStorage.getItem('theme') || '';
            const isDark = currentTheme === 'dark';
            const pagebody = document.getElementsByTagName('body')[0]
            if (isDark) {
                pagebody.classList.add('dark-theme');
                // mobile
                document.getElementById("mobile-toggle-theme").innerText = "· Dark"
            } else {
                pagebody.classList.remove('dark-theme');
                // mobile
                document.getElementById("mobile-toggle-theme").innerText = "· Light"
            }
        })();
    </script>

    <div class="wrapper">
        <header>
    <nav class="navbar">
        <div class="container">
            <div class="navbar-header header-logo"><a href="/">Do It</a></div>
            <div class="menu navbar-right">
                
                    <a class="menu-item" href="/category">Categories</a>
                
                    <a class="menu-item" href="/tag">Tags</a>
                
                    <a class="menu-item" href="/archives">Archives</a>
                
                    <a class="menu-item" href="/about">About</a>
                
                <input id="switch_default" type="checkbox" class="switch_default">
                <label for="switch_default" class="toggleBtn"></label>
            </div>
        </div>
    </nav>

    
    <nav class="navbar-mobile" id="nav-mobile">
        <div class="container">
            <div class="navbar-header">
                <div>
                    <a href="/">Do It</a><a id="mobile-toggle-theme">·&nbsp;Light</a>
                </div>
                <div class="menu-toggle" onclick="mobileBtn()">&#9776; Menu</div>
            </div>
            <div class="menu" id="mobile-menu">
                
                    <a class="menu-item" href="/category">Categories</a>
                
                    <a class="menu-item" href="/tag">Tags</a>
                
                    <a class="menu-item" href="/archives">Archives</a>
                
                    <a class="menu-item" href="/about">About</a>
                
            </div>
        </div>
    </nav>

</header>
<script>
    var mobileBtn = function f() {
        var toggleMenu = document.getElementsByClassName("menu-toggle")[0];
        var mobileMenu = document.getElementById("mobile-menu");
        if(toggleMenu.classList.contains("active")){
           toggleMenu.classList.remove("active")
            mobileMenu.classList.remove("active")
        }else{
            toggleMenu.classList.add("active")
            mobileMenu.classList.add("active")
        }
    }
</script>
            <div class="main">
                <div class="container">
    
    
        <div class="post-toc">
    <div class="tocbot-list">
    </div>
    <div class="tocbot-list-menu">
        <a class="tocbot-toc-expand" onclick="expand_toc()">Expand all</a>
        <a onclick="go_top()">Back to top</a>
        <a onclick="go_bottom()">Go to bottom</a>
    </div>
</div>

<script>
    var tocbot_timer;
    var DEPTH_MAX = 6; // 为 6 时展开所有
    var tocbot_default_config = {
        tocSelector: '.tocbot-list',
        contentSelector: '.post-content',
        headingSelector: 'h1, h2, h3, h4, h5',
        orderedList: false,
        scrollSmooth: true,
        onClick: extend_click,
    };

    function extend_click() {
        clearTimeout(tocbot_timer);
        tocbot_timer = setTimeout(function() {
            tocbot.refresh(obj_merge(tocbot_default_config, {
                hasInnerContainers: true
            }));
        }, 420); // 这个值是由 tocbot 源码里定义的 scrollSmoothDuration 得来的
    }

    document.ready(function() {
        tocbot.init(obj_merge(tocbot_default_config, {
            collapseDepth: 1
        }));
    });

    function expand_toc() {
        var b = document.querySelector('.tocbot-toc-expand');
        var expanded = b.getAttribute('data-expanded');
        expanded ? b.removeAttribute('data-expanded') : b.setAttribute('data-expanded', true);
        tocbot.refresh(obj_merge(tocbot_default_config, {
            collapseDepth: expanded ? 1 : DEPTH_MAX
        }));
        b.innerText = expanded ? 'Expand all' : 'Collapse all';
    }

    function go_top() {
        window.scrollTo(0, 0);
    }

    function go_bottom() {
        window.scrollTo(0, document.body.scrollHeight);
    }

    function obj_merge(target, source) {
        for (var item in source) {
            if (source.hasOwnProperty(item)) {
                target[item] = source[item];
            }
        }
        return target;
    }
</script>
    

    
    <article class="post-wrap">
        <header class="post-header">
            <h1 class="post-title">安卓音视频——编解码</h1>
            
                <div class="post-meta">
                    
                        Author: <a itemprop="author" rel="author" href="/">York</a>
                    

                    
                        <span class="post-time">
                        Date: <a href="#">2019 /08 /20&nbsp;&nbsp;14:21:00</a>
                        </span>
                    
                    
                </div>
            
        </header>

        <div class="post-content">
            <p>这是关于安卓音视频的一个系列文章。大家可以从这里随意跳跃：</p>
<p><a href="http://york-2016.github.io/2019/08/14/%E5%AE%89%E5%8D%93%E9%9F%B3%E8%A7%86%E9%A2%91%E2%80%94%E2%80%94%E5%9F%BA%E7%A1%80%E7%AF%87/" title="安卓音视频——基础篇">《安卓音视频》</a></p>
<p><a href="http://york-2016.github.io/2019/08/16/%E5%AE%89%E5%8D%93%E9%9F%B3%E8%A7%86%E9%A2%91%E2%80%94%E2%80%94%E9%9F%B3%E9%A2%91%E6%A8%A1%E5%9D%97/" title="安卓音视频——音频模块">《安卓音视频——音频模块》</a></p>
<p><a href="http://york-2016.github.io/2019/08/20/%E5%AE%89%E5%8D%93%E9%9F%B3%E8%A7%86%E9%A2%91%E2%80%94%E2%80%94%E7%BC%96%E8%A7%A3%E7%A0%81/" title="安卓音视频——编解码">《安卓音视频——编解码》</a></p>
<blockquote>
<p>摘要：多媒体视频不光包括了音频部分，还有图像部分。一个视频文件的录制和播放，伴随着音视频的编解码过程，而编解码也是多媒体开发中很重要的一个知识点。上2篇文章我们对安卓音频的知识点进行了梳理。在这篇文章中，我会基于之前整理的内容，同时重点围绕多媒体视频来叙述。</p>
</blockquote>
<h1 id="1-容器（封装）格式与编码方式"><a href="#1-容器（封装）格式与编码方式" class="headerlink" title="1.容器（封装）格式与编码方式"></a>1.容器（封装）格式与编码方式</h1><p>视频是现在电脑中多媒体系统中的重要一环。为了适应储存视频的需要，人们设定了不同的视频文件格式来把视频和音频放在一个文件中，以方便同时回放。一个视频文件实际上是在一个文件里面包含了编码过的视频轨道、编码过的音频轨道，还有各种文件描述信息。</p>
<h2 id="1-1-编码格式"><a href="#1-1-编码格式" class="headerlink" title="1.1 编码格式"></a>1.1 编码格式</h2><p>编码格式就是指通过特定的压缩技术，将某个视频格式的文件转换成另一种视频格式文件存在的方法。音视频编码格式分为视频编码格式和音频编码格式。</p>
<p><strong>视频编码</strong>的主要作用是将视频像素数据（RGB，YUV等）压缩成为视频码流，从而降低视频的数据量。不同编码方法的区别主要是压缩算法的不同。视频编码的目的主要是压缩数据体积。</p>
<p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly93d3cueW9ya3l1ZS5jb20vcGljcy9jdXRfYW5kb3JpZF92aWRlb19jb2RlYy5wbmc?x-oss-process=image/format,png" alt="在这里插入图片描述"></p>
<p>视频中常用的编码标准有<strong>H.26X系列</strong>，<strong>MPEG系列</strong>，移动端使用最多的是MP4视频文件，主要使用H.264 AVC编码格式。</p>
<p>有关视频编码的原理可以看一看 雷霄骅 的这篇文章：<a target="_blank" rel="noopener" href="https://blog.csdn.net/leixiaohua1020/article/details/28114081" title="视频压缩编码和音频压缩编码的基本原理">视频压缩编码和音频压缩编码的基本原理</a></p>
<p><strong>音频编码</strong>的主要作用是将音频采样数据（PCM 等）压缩成为音频码流，从而降低音频的数据量,偏于存储和传输，跟视频编码的作用类似。</p>
<p>音频中常用的编码格式有以下：</p>
<p><strong>① WAV</strong></p>
<p>PCM（脉冲编码调制）是 Pulse Code Modulation 的缩写。WAV 编码的一种实现（有多种实现方式，但是都不会进行压缩操作）就是在 PCM 数据格式的前面加上 44 字节，分别用来描述 PCM 的采样率、声道数、数据格式等信息。</p>
<p>特点：音质非常好，大量软件都支持。</p>
<p>适用场合：多媒体开发的中间文件、保存音乐和音效素材。</p>
<p><strong>② MP3(有损)</strong></p>
<p>MP3 具有不错的压缩比，使用 LAME 编码（MP3 编码格式的一种实现）的中高码率的 MP3 文件，听感上非常接近源 WAV 文件，当然在不同的应用场景下，应该调整合适的参数以达到最好的效果。</p>
<p>特点：音质在 128Kbit&#x2F;s 以上表现还不错，压缩比比较高，大量软件和硬件都支持，兼容性好。</p>
<p>适用场合：高比特率下对兼容性有要求的音乐欣赏。</p>
<p><strong>③ AAC(有损)</strong></p>
<p>AAC 是新一代的音频有损压缩技术，它通过一些附加的编码技术（比如 PS、SBR 等），衍生出了 LC-AAC、HE-AAC、HE-AAC v2 三种主要的编码格式。</p>
<p>LC-AAC 是比较传统的 AAC，相对而言，其主要应用于中高码率场景的编码（≥80Kbit&#x2F;s）；</p>
<p>HE-AAC（相当于AAC+SBR）主要应用于中低码率场景的编码（≤80Kbit&#x2F;s）；</p>
<p>而新近推出的 HE-AAC v2（相当于AAC+SBR+PS）主要应用于低码率场景的编码（≤48Kbit&#x2F;s）。事实上大部分编码器都设置为 ≤48Kbit&#x2F;s 自动启用 PS 技术，而 &gt;48Kbit&#x2F;s 则不加PS，相当于普通的 HE-AAC。</p>
<p>特点：在小于 128Kbit&#x2F;s 的码率下表现优异，并且多用于视频中的音频编码。</p>
<p>适用场合：128Kbit&#x2F;s 以下的音频编码，多用于视频中音频轨的编码。</p>
<p><strong>④ Ogg(有损)</strong></p>
<p>Ogg 是一种非常有潜力的编码，在各种码率下都有比较优秀的表现，尤其是在中低码率场景下。Ogg 除了音质好之外，还是完全免费的，这为 Ogg 获得更多的支持打好了基础。Ogg 有着非常出色的算法，可以用更小的码率达到更好的音质，128Kbit&#x2F;s 的 Ogg 比 192Kbit&#x2F;s 甚至更高码率的 MP3 还要出色。但目前因为还没有媒体服务软件的支持，因此基于 Ogg 的数字广播还无法实现。Ogg 目前受支持的情况还不够好，无论是软件上的还是硬件上的支持，都无法和 MP3 相提并论。</p>
<p>特点：可以用比 MP3 更小的码率实现比 MP3 更好的音质，高中低码率下均有良好的表现，兼容性不够好，流媒体特性不支持。</p>
<p>适用场合：语音聊天的音频消息场景。</p>
<p><strong>⑤ APE（无损）</strong></p>
<p>APE 是流行的数字音乐无损压缩格式之一，因出现较早，在全世界特别是中国大陆有着广泛的用户群。与 MP3 这类有损压缩格式不可逆转地删除（人耳听力不敏感的）数据以缩减源文件体积不同，APE 这类无损压缩格式，是以更精炼的记录方式来缩减体积，还原后数据与源文件一样，从而保证了文件的完整性。</p>
<p>APE 由软件 Monkey’s audio 压制得到，开发者为 Matthew T. Ashland，源代码开放，因其界面上有只 “猴子” 标志而出名。相较同类文件格式 FLAC，ape 有查错能力但不提供纠错功能，以保证文件的无损和纯正；其另一个特色是压缩率约为 55%，比 FLAC 高，体积大概为原 CD 的一半，便于存储。</p>
<p>APE 作为一种无损压缩音频格式，通过 Monkey’s Audio 这个软件可以将庞大的 WAV 音频文件压缩为 APE,，体积虽然变小了，但音质和原来一样。通过 Monkey’s Audio 解压缩还原以后得到的 WAV 文件可以做到与压缩前的源文件完全一致。所以 APE 被誉为“无损音频压缩格式”，Monkey’’s Audio 被誉为“无损音频压缩软件”。</p>
<p>简单来讲，APE 压缩与 WinZip 或 WinRAR 这类专业数据压缩软件压缩原理类似，只是 APE 等无损压缩数字音乐之后的 APE 音频文件是可以直接被播放的。APE 的压缩速率是动态的，压缩时只压缩可被压缩部分，不能被压缩的部分还是会保留下来。</p>
<p><strong>⑥ FLAC（无损）</strong></p>
<p>FLAC 中文可解释为无损音频压缩编码。FLAC 是一套著名的自由音频压缩编码，其特点是无损压缩。不同于其他有损压缩编码如 MP3 及 AAC，它不会破坏任何原有的音频资讯，所以可以还原音乐光盘音质。2012 年以来它已被很多软件及硬件音频产品（如 CD 等）所支持.</p>
<p>FLAC 与 MP3 不同，MP3 是音频压缩编码，但 FLAC 是无损压缩，也就是说音频以 FLAC 编码压缩后不会丢失任何信息，将 FLAC 件还原为 WAV 文件后，与压缩前的 WAV 文件内容相同。这种压缩与 ZIP 的方式类似，但 FLAC 的压缩比率大于 ZIP 和 RAR，因为 FLAC 是专门针对 PCM 音频的特点设计的压缩方式。而且可以使用播放器直接播放 FLAC 压缩的文件，就象通常播放你的 MP3 文件一样（近几年已经有许多汽车播放器和家用音响设备支持 FLAC，在 FLAC 的网站上你可以找到这些设备厂家的链接）。</p>
<p>有关音频编码的内容可以看一看这篇文章：<a target="_blank" rel="noopener" href="https://blog.csdn.net/houxiaoni01/article/details/78810674" title="常见音频编码格式解析">常见音频编码格式解析</a></p>
<h2 id="1-2-容器（封装）格式"><a href="#1-2-容器（封装）格式" class="headerlink" title="1.2 容器（封装）格式"></a>1.2 容器（封装）格式</h2><p>我们知道，视频文件需要同时包含音频数据和图像数据，有时还会加入一些其它的数据，例如字幕。这些数据可能会被不同的程序或者硬件处理，但是当它们要进行传输或者存储的时候，这三种数据通常是被封装在一起的，这个存放封装数据的东西，就可以称为 <strong>容器</strong>，也就是我们日常所知道的 视频 <strong>文件格式</strong>。例如常见的*.mpg, *.avi, *.mov, *.mp4, *.rm, *.ogg, *.tta等格式，都可以说是一种视频容器。视频容器的格式会关系到这个视频文件的可扩展性。</p>
<p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly93d3cueW9ya3l1ZS5jb20vcGljcy9jdXRfYW5kb3JpZF92aWRlb19zdHlsZS5wbmc?x-oss-process=image/format,png" alt="在这里插入图片描述"></p>
<h1 id="2-音视频-MPEG-介绍"><a href="#2-音视频-MPEG-介绍" class="headerlink" title="2. 音视频 MPEG 介绍"></a>2. 音视频 MPEG 介绍</h1><blockquote>
<p><strong>MPEG</strong> 是Moving Picture Experts Group的简称。这个名字本来的含义是指一个研究视频和音频编码标准的小组。现在我们所说的MPEG泛指又该小组制定的一系列视频编码标准。该小组于 1988年组成，至今已经制定了MPEG-1、MPEG-2、MPEG-3、MPEG-4、MPEG-7等多个标准，MPEG-21正在制定中。</p>
</blockquote>
<h2 id="2-1-AAC音频"><a href="#2-1-AAC音频" class="headerlink" title="2.1 AAC音频"></a>2.1 AAC音频</h2><p>AAC是高级音频编码（Advanced Audio Coding）的缩写，出现于1997年，最初是基于MPEG-2的音频编码技术。由Fraunhofer IIS、Dolby Laboratories、AT&amp;T、Sony等公司共同开发，目的是取代MP3格式。</p>
<p>AAC是新一代的音频有损压缩技术，它通过一些附加的编码技术（比如PS,SBR等），衍生出了 <strong>LC-AAC</strong>, <strong>HE-AAC</strong> , <strong>HE-AACv2</strong> 三种主要的编码。</p>
<ul>
<li><strong>LC-AAC</strong> 就是比较传统的AAC，相对而言，主要用于中高码率(&gt;&#x3D;80Kbps)；</li>
<li><strong>HE-AAC</strong> (相当于AAC+SBR)主要用于中低码(&lt;&#x3D;80Kbps)；</li>
<li><strong>HE-AACv2</strong> (相当于AAC+SBR+PS)为最新推出，主要用于低码率(&lt;&#x3D;48Kbps）</li>
</ul>
<p>目前使用最多的是 <strong>LC-AAC</strong> 和 <strong>HE-AAC</strong> (适合低码率)。流行的Nero AAC编码程序只支持LC，HE，HEv2这三种规格，编码后的AAC音频，规格显示都是LC。HE其实就是AAC（LC）+SBR技术，HEv2就是AAC（LC）+SBR+PS技术；事实上大部分编码器设成&lt;&#x3D;48Kbps自动启用PS技术，而&gt;48Kbps就不加PS，就相当于普通的HE-AAC。</p>
<p>扩展名：.m4a, .m4b, .m4p, .m4v, .m4r, .3gp, .mp4, .aac<br>互联网媒体类型：audio&#x2F;aac, audio&#x2F;aacp, audio&#x2F;3gpp, audio&#x2F;3gpp2,audio&#x2F;mp4, audio&#x2F;MP4A-LATM, audio&#x2F;mpeg4-generic<br>格式：有损数据压缩<br>延伸自：MPEG-2 音频<br>标准：ISO&#x2F;IEC 13818-7（MPEG-2第7部）, ISO&#x2F;IEC 14496-3（MPEG-4第3部）</p>
<p>AAC格式的主要扩展名有三种：</p>
<ul>
<li>AAC - 使用MPEG-2 Audio Transport Stream( ADTS，参见MPEG-2 )容器，区别于使用MPEG-4容器的MP4&#x2F;M4A格式，属于传统的AAC编码（FAAC默认的封装，但FAAC亦可输出 MPEG-4 封装的AAC）</li>
<li>MP4 - 使用了MPEG-4 Part 14（第14部分）的简化版即3GPP Media Release 6 Basic (3gp6，参见3GP ) 进行封装的AAC编码（Nero AAC 编码器仅能输出MPEG-4封装的AAC）；</li>
<li>M4A - 为了区别纯音频MP4文件和包含视频的MP4文件而由苹果(Apple)公司使用的扩展名，Apple iTunes 对纯音频MP4文件采用了”.M4A”命名。M4A的本质和音频MP4相同，故音频MP4文件亦可直接更改扩展名为M4A。</li>
</ul>
<p>作为一种高压缩比的音频压缩算法，AAC压缩比通常为18：1，也有资料说为20：1，远胜mp3； 在音质方面，由于采用多声道，和使用低复杂性的描述方式，使其比几乎所有的传统编码方式在同规格的情况下更胜一筹。不过直到2006年， 使用这一格式储存音乐的并不多。</p>
<h3 id="2-1-1-AAC音频文件格式"><a href="#2-1-1-AAC音频文件格式" class="headerlink" title="2.1.1 AAC音频文件格式"></a>2.1.1 AAC音频文件格式</h3><p>AAC的音频文件格式有 <strong>ADIF</strong> ＆ <strong>ADTS</strong> &amp; <strong>LATM</strong> 。</p>
<ul>
<li><p><strong>ADIF</strong>：Audio Data Interchange Format 音频数据交换格式。这种格式的特征是可以确定的找到这个音频数据的开始，不需进行在音频数据流中间开始的解码，即它的解码必须在明确定义的开始处进行。故这种格式常用在磁盘文件中。</p>
</li>
<li><p><strong>ADTS</strong>：Audio Data Transport Stream 音频数据传输流。这种格式的特征是它是一个有同步字的比特流，解码可以在这个流中任何位置开始。它的特征类似于mp3数据流格式。</p>
</li>
<li><p><strong>LATM</strong> 的全称为“Low-overhead MPEG-4 Audio TransportMultiplex”（低开销音频传输复用），是MPEG-4 AAC制定的一种高效率的码流传输方式，MPEG-2 TS流也采用LATM作为AAC音频码流的封装格式之一。</p>
</li>
</ul>
<p>简单的说，ADTS可以在任意帧解码，也就是说它每一帧都有头信息。ADIF只有一个统一的头，所以必须得到所有的数据后解码。且这两种的header的格式也是不同的，目前一般编码后的和抽取出的都是ADTS格式的音频流。</p>
<h3 id="2-1-2-AAC文件处理流程"><a href="#2-1-2-AAC文件处理流程" class="headerlink" title="2.1.2 AAC文件处理流程"></a>2.1.2 AAC文件处理流程</h3><ul>
<li>(1) 判断文件格式，确定为ADIF或ADTS</li>
<li>(2) 若为ADIF，解ADIF头信息，跳至第6步。</li>
<li>(3) 若为ADTS，寻找同步头。</li>
<li>(4) 解ADTS帧头信息。</li>
<li>(5) 若有错误检测，进行错误检测。</li>
<li>(6) 解块信息。</li>
<li>(7) 解元素信息。</li>
</ul>
<h2 id="2-2-H-26x介绍"><a href="#2-2-H-26x介绍" class="headerlink" title="2.2 H.26x介绍"></a>2.2 H.26x介绍</h2><p><strong>H.26x</strong> 有H.261,H.262，H.263, H.263v2以及H.264，H.261基本上已经不再使用。这里重点讲一下H.264。</p>
<p><strong>H.264／AVC</strong> 是一种视频高压缩技术，同时称为MPEG-4 AVC，或MPEG-4 Part10。 H.264 可工作于多种速率，广泛应用于Internet／intranet上的多媒体流服务、视频点播、可视游戏、低码率移动多媒体通信 (视频 手机等)、交互式多媒体应用、实时多媒体监控、数字电视与演播电视和虚拟视频会议等，大有在上述领域一统天下的趋势，有非常广泛的开发和应用前景。H.264集中体现了当今国际视频编码解码技术的最新成果。在相同的重建图像质量下，H.264比其他视频压缩编码具有更高的压缩比、 更好的IP和无线网络信道适应性。</p>
<p>H.264 标准分为三档：<strong>基本档次</strong>；<strong>主要档次</strong>（可用于SDTV、HDTV和DVD等）；以及<strong>扩展档次</strong>（用于网络的视频流）</p>
<h3 id="2-2-1-序列"><a href="#2-2-1-序列" class="headerlink" title="2.2.1 序列"></a>2.2.1 序列</h3><p>在H264中，图像以序列为单位进行组织，一个序列是一段图像编码后的数据流，以I帧开始，到下一个I帧结束。一个序列的第一个图像叫做IDR图像（立即刷新图像），IDR图像都是I帧图像。H.264引入IDR图像是为了解码的重同步，当解码器解码到IDR图像时，立即将参考帧队列清空，将已编码的数据全部输出或抛弃，重新查找参数集，开始一个新的序列。这样，如果前一个序列出现重大错误，在这里可以获得重新同步的机会，IDR图像之后的图像永远不会使用IDR之前的图片的数据来编码。</p>
<p>一个序列就是一段内容差异不太大的图像编码后生产的一串数据流。当运动变化比较少时，一个序列可以很长，因为运动变化少就代表图像画面的内容变动很小，所以就可以遍一个I镇，然后一个P帧，B帧了。当运动变化多时，可能一个序列就比较短了，比如就包含一个I帧和3，4个P帧。</p>
<p>一个 I 帧可以不依赖其他帧就解码出一幅完整的图像，而 P 帧、B 帧不行。P 帧需要依赖视频流中排在它前面的帧才能解码出图像。B 帧则需要依赖视频流中排在它前面或后面的帧才能解码出图像。</p>
<h3 id="2-2-2-DTS-amp-PTS"><a href="#2-2-2-DTS-amp-PTS" class="headerlink" title="2.2.2 DTS &amp; PTS"></a>2.2.2 DTS &amp; PTS</h3><p><strong>DTS</strong>：解码时间戳，这个事件戳的意义在于告诉播放器该在什么时候解码这一帧的数据。<br><strong>PTS</strong>：显示时间戳，这个事件戳用来告诉播放器该什么时候显示这一帧的数据。</p>
<p>当视频流中没有 B 帧时，通常 DTS 和 PTS 的顺序是一致的。但如果有 B 帧时，解码顺序和播放顺序就不一致了。</p>
<p>比如一个视频中，帧的显示顺序是：I B B P，现在我们需要在解码 B 帧时知道 P 帧中信息，因此这几帧在视频流中的顺序可能是：I P B B，这时候就体现出每帧都有 DTS 和 PTS 的作用了。它们的顺序大概如下：</p>
<p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly93d3cueW9ya3l1ZS5jb20vcGljcy9jdXRfdmlkZW9faXBiLnBuZw?x-oss-process=image/format,png" alt="在这里插入图片描述"></p>
<h1 id="3-安卓-MP4-视频文件的编解码举例"><a href="#3-安卓-MP4-视频文件的编解码举例" class="headerlink" title="3. 安卓 MP4 视频文件的编解码举例"></a>3. 安卓 MP4 视频文件的编解码举例</h1><p>以最多见的MP4为例，简单整理一下安卓开发中的视频编解码流程。下图可以看作是MP4文件的录制与播放流程。我将从这2个图对其展开叙述。</p>
<p><strong>视频录制流程：</strong></p>
<p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly93d3cueW9ya3l1ZS5jb20vcGljcy9jdXRfdmlkZW9fcmVjb3JkZXJfc3RlcC5wbmc?x-oss-process=image/format,png" alt="在这里插入图片描述"></p>
<p><strong>视频播放流程：</strong></p>
<p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly93d3cueW9ya3l1ZS5jb20vcGljcy9jdXRfdmlkZW9fcGxheV9zdGVwLnBuZw?x-oss-process=image/format,png" alt="在这里插入图片描述"></p>
<p>应该是能够看得懂我画的是什么，要是看不懂那就过，往下看。</p>
<h2 id="3-1-MP4-文件编码录制"><a href="#3-1-MP4-文件编码录制" class="headerlink" title="3.1 MP4 文件编码录制"></a>3.1 MP4 文件编码录制</h2><p>先来看一下MP4文件录制流程的简单框图，为了不影响看图，我把图再贴一下在下面。从图中可以看出，MP4录制的过程包含了3个重要部分：</p>
<ul>
<li>声音的录制</li>
<li>图像的录制</li>
<li>声音与图像的合并</li>
</ul>
<p>在声音的录制、图像的录制中就分别涉及到了音频、视频的编码。图中音频数据需要被编码成AAC；图像数据需要被编码成H264。然后通过安卓中的 MediaMuxer 进行音视频的合并，合并中同步音频和图像2者的时间戳，这样一个MP4文件就诞生了。</p>
<p>关于MP4的录制，重点也就是 <strong>音频数据编码到AAC</strong>、<strong>图像数据编码到H264</strong>、<strong>以及音视频数据合并成MP4</strong> 这3块内容。本篇文章重点讲解音视频的编解码。编码使用到的编码器 为MediaCodec，对此我已做好了封装。一个录制MP4的过程，我们有这3个线程。分别是 AudioEncodecThread；VideoEncodecThread；EGLMediaThread（预览）。以下是编码初始化代码。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">initMediaEncodec</span><span class="params">(String savePath, <span class="type">int</span> width, <span class="type">int</span> height, <span class="type">int</span> sampleRate, <span class="type">int</span> channelCount)</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        LogAAR.e(<span class="string">&quot;initMediaEncodec:--&gt;savePath=&quot;</span>+savePath+<span class="string">&quot;,size: w * h =&quot;</span>+width+<span class="string">&quot;*&quot;</span>+height+<span class="string">&quot;,sampleRate=&quot;</span>+sampleRate+<span class="string">&quot;,channelCount=&quot;</span>+channelCount);</span><br><span class="line">        mediaMuxer = <span class="keyword">new</span> <span class="title class_">MediaMuxer</span>(savePath, MediaMuxer.OutputFormat.MUXER_OUTPUT_MPEG_4);</span><br><span class="line">        initVideoEncodec(MediaFormat.MIMETYPE_VIDEO_AVC, width, height);</span><br><span class="line">        initAudioEncodec(MediaFormat.MIMETYPE_AUDIO_AAC, sampleRate, channelCount);</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>代码中，初始化时已经将MP4需要的编码格式传进编码器，音频和视频分别是MediaFormat.MIMETYPE_AUDIO_AA 和 MediaFormat.MIMETYPE_VIDEO_AVC。这样编码器会按照我们所传参数分别对音频、视频编码进行初始化。以下是分别对音频、视频编码器进行初始化代码。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">initVideoEncodec</span><span class="params">(String mimeType, <span class="type">int</span> width, <span class="type">int</span> height)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            videoBufferinfo = <span class="keyword">new</span> <span class="title class_">MediaCodec</span>.BufferInfo();</span><br><span class="line">            videoFormat = MediaFormat.createVideoFormat(mimeType, width, height);</span><br><span class="line">            videoFormat.setInteger(MediaFormat.KEY_COLOR_FORMAT, MediaCodecInfo.CodecCapabilities.COLOR_FormatSurface);</span><br><span class="line">            videoFormat.setInteger(MediaFormat.KEY_BIT_RATE, width * height * <span class="number">4</span>);</span><br><span class="line">            videoFormat.setInteger(MediaFormat.KEY_FRAME_RATE, <span class="number">30</span>);</span><br><span class="line">            videoFormat.setInteger(MediaFormat.KEY_I_FRAME_INTERVAL, <span class="number">1</span>);</span><br><span class="line">            videoEncodec = MediaCodec.createEncoderByType(mimeType);</span><br><span class="line">            videoEncodec.configure(videoFormat, <span class="literal">null</span>, <span class="literal">null</span>, MediaCodec.CONFIGURE_FLAG_ENCODE);</span><br><span class="line">            surface = videoEncodec.createInputSurface();</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            videoEncodec = <span class="literal">null</span>;</span><br><span class="line">            videoFormat = <span class="literal">null</span>;</span><br><span class="line">            videoBufferinfo = <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">initAudioEncodec</span><span class="params">(String mimeType, <span class="type">int</span> sampleRate, <span class="type">int</span> channelCount)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            audioBufferinfo = <span class="keyword">new</span> <span class="title class_">MediaCodec</span>.BufferInfo();</span><br><span class="line">            audioFormat = MediaFormat.createAudioFormat(mimeType, sampleRate, channelCount);</span><br><span class="line">            audioFormat.setInteger(MediaFormat.KEY_BIT_RATE, sampleRate*channelCount*<span class="number">16</span>);</span><br><span class="line">            audioFormat.setInteger(MediaFormat.KEY_AAC_PROFILE, MediaCodecInfo.CodecProfileLevel.AACObjectLC);</span><br><span class="line">            audioFormat.setInteger(MediaFormat.KEY_MAX_INPUT_SIZE, <span class="number">96000</span>);</span><br><span class="line"></span><br><span class="line">            audioEncodec = MediaCodec.createEncoderByType(mimeType);</span><br><span class="line">            audioEncodec.configure(audioFormat, <span class="literal">null</span>, <span class="literal">null</span>, MediaCodec.CONFIGURE_FLAG_ENCODE);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            audioBufferinfo = <span class="literal">null</span>;</span><br><span class="line">            audioFormat = <span class="literal">null</span>;</span><br><span class="line">            audioEncodec = <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>接下来分开讲 <strong>音频数据编码到AAC</strong>、<strong>图像数据编码到H264</strong>、<strong>以及音视频数据合并成MP4</strong> 的内容。</p>
<p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly93d3cueW9ya3l1ZS5jb20vcGljcy9jdXRfdmlkZW9fcmVjb3JkZXJfc3RlcC5wbmc?x-oss-process=image/format,png" alt="在这里插入图片描述"></p>
<h3 id="3-1-1-音频数据编码到AAC"><a href="#3-1-1-音频数据编码到AAC" class="headerlink" title="3.1.1 音频数据编码到AAC"></a>3.1.1 音频数据编码到AAC</h3><p>音频数据编码到AAC，过程是需要将录音机得到的音频PCM数据实时传入 MediaCodec，由MediaCodec完成音频数据编码得到AAC的过程，音频数据被编码为AAC，我们再将音频的AAC数据传入到 MediaMuxer。于此同时，视频数据的编码以及写入MediaMuxer也在同步进行。音频编码线程的代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">putPCMData</span><span class="params">(<span class="type">byte</span>[] buffer, <span class="type">int</span> size)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (audioEncodecThread != <span class="literal">null</span> &amp;&amp; !audioEncodecThread.isExit &amp;&amp; buffer != <span class="literal">null</span> &amp;&amp; size &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (audioEncodec!=<span class="literal">null</span>)&#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="type">int</span> <span class="variable">inputBufferindex</span> <span class="operator">=</span> audioEncodec.dequeueInputBuffer(<span class="number">0</span>);</span><br><span class="line">                    <span class="keyword">if</span> (inputBufferindex &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                        <span class="type">ByteBuffer</span> <span class="variable">byteBuffer</span> <span class="operator">=</span> audioEncodec.getInputBuffers()[inputBufferindex];</span><br><span class="line">                        byteBuffer.clear();</span><br><span class="line">                        byteBuffer.put(buffer);</span><br><span class="line">                        <span class="type">long</span> <span class="variable">result</span> <span class="operator">=</span> System.nanoTime() ;</span><br><span class="line">                        <span class="type">long</span> <span class="variable">time</span> <span class="operator">=</span> (result - audioEncodecThread.baseTimeStamp ) / <span class="number">1000</span>;</span><br><span class="line"></span><br><span class="line">                        audioEncodec.queueInputBuffer(inputBufferindex, <span class="number">0</span>, size, time, <span class="number">0</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">AudioEncodecThread</span> <span class="keyword">extends</span> <span class="title class_">Thread</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> WeakReference&lt;YorkBaseMediaEncoder&gt; encoder;</span><br><span class="line">        <span class="keyword">private</span> <span class="type">boolean</span> isExit;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> MediaCodec audioEncodec;</span><br><span class="line">        <span class="keyword">private</span> MediaCodec.BufferInfo bufferInfo;</span><br><span class="line">        <span class="keyword">private</span> MediaMuxer mediaMuxer;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="type">int</span> <span class="variable">audioTrackIndex</span> <span class="operator">=</span> -<span class="number">1</span>;</span><br><span class="line">        <span class="type">long</span> pts;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">AudioEncodecThread</span><span class="params">(WeakReference&lt;YorkBaseMediaEncoder&gt; encoder)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.encoder = encoder;</span><br><span class="line">            audioEncodec = encoder.get().audioEncodec;</span><br><span class="line">            bufferInfo = encoder.get().audioBufferinfo;</span><br><span class="line">            mediaMuxer = encoder.get().mediaMuxer;</span><br><span class="line">            audioTrackIndex = -<span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="built_in">super</span>.run();</span><br><span class="line">            pts = <span class="number">0</span>;</span><br><span class="line">            isExit = <span class="literal">false</span>;</span><br><span class="line">            audioEncodec.start();</span><br><span class="line">            <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (isExit) &#123;</span><br><span class="line">                    audioEncodec.stop();</span><br><span class="line">                    audioEncodec.release();</span><br><span class="line">                    audioEncodec = <span class="literal">null</span>;</span><br><span class="line">                    encoder.get().audioExit = <span class="literal">true</span>;</span><br><span class="line">                    <span class="keyword">if</span> (encoder.get().videoExit) &#123;</span><br><span class="line">                        mediaMuxer.stop();</span><br><span class="line">                        mediaMuxer.release();</span><br><span class="line">                        mediaMuxer = <span class="literal">null</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (audioEncodec==<span class="literal">null</span>)&#123;</span><br><span class="line">                    isExit=<span class="literal">true</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="type">int</span> <span class="variable">outputBufferIndex</span> <span class="operator">=</span> audioEncodec.dequeueOutputBuffer(bufferInfo, <span class="number">0</span>);</span><br><span class="line">                <span class="keyword">if</span> (outputBufferIndex == MediaCodec.INFO_OUTPUT_FORMAT_CHANGED) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (mediaMuxer != <span class="literal">null</span>) &#123;</span><br><span class="line">                        audioTrackIndex = mediaMuxer.addTrack(audioEncodec.getOutputFormat());</span><br><span class="line">                        <span class="keyword">if</span> (encoder.get().videoEncodecThread.videoTrackIndex != -<span class="number">1</span>) &#123;</span><br><span class="line">                            mediaMuxer.start();</span><br><span class="line">                            encoder.get().encodecStart = <span class="literal">true</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">while</span> (outputBufferIndex &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (encoder.get().encodecStart) &#123;</span><br><span class="line">                            <span class="type">ByteBuffer</span> <span class="variable">outputBuffer</span> <span class="operator">=</span> audioEncodec.getOutputBuffers()[outputBufferIndex];</span><br><span class="line">                            outputBuffer.position(bufferInfo.offset);</span><br><span class="line">                            outputBuffer.limit(bufferInfo.offset + bufferInfo.size);</span><br><span class="line">                            bufferInfo.presentationTimeUs = getPTSUs();</span><br><span class="line">                            mediaMuxer.writeSampleData(audioTrackIndex, outputBuffer, bufferInfo);</span><br><span class="line">                        &#125;</span><br><span class="line">                        audioEncodec.releaseOutputBuffer(outputBufferIndex, <span class="literal">false</span>);</span><br><span class="line">                        outputBufferIndex = audioEncodec.dequeueOutputBuffer(bufferInfo, <span class="number">0</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">private</span> <span class="type">long</span> <span class="variable">baseTimeStamp</span> <span class="operator">=</span> -<span class="number">1</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="type">long</span> <span class="title function_">getPTSUs</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="type">long</span> <span class="variable">result</span> <span class="operator">=</span> System.nanoTime() ;</span><br><span class="line">            <span class="type">long</span> <span class="variable">time</span> <span class="operator">=</span> (result - baseTimeStamp ) / <span class="number">1000</span>;</span><br><span class="line">            <span class="keyword">if</span> (time &lt; <span class="number">0</span>)&#123;</span><br><span class="line">                <span class="keyword">return</span>  <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> time;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">exit</span><span class="params">()</span> &#123;</span><br><span class="line">            isExit = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>


<h3 id="3-1-2-图像数据编码到H264"><a href="#3-1-2-图像数据编码到H264" class="headerlink" title="3.1.2 图像数据编码到H264"></a>3.1.2 图像数据编码到H264</h3><p>图像数据编码到H264，原理是将Camera得到的图像数据实时传入 MediaCodec，由 MediaCodec 进行编码得到H264数据，当数据被编码得到了H264数据,我们再将H264数据传入到 MediaMuxer。图像数据编码线程的代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">VideoEncodecThread</span> <span class="keyword">extends</span> <span class="title class_">Thread</span> &#123;</span><br><span class="line">       <span class="keyword">private</span> WeakReference&lt;YorkBaseMediaEncoder&gt; encoder;</span><br><span class="line">       <span class="keyword">private</span> <span class="type">boolean</span> isExit;</span><br><span class="line">       <span class="keyword">private</span> MediaCodec videoEncodec;</span><br><span class="line">       <span class="keyword">private</span> MediaCodec.BufferInfo videoBufferinfo;</span><br><span class="line">       <span class="keyword">private</span> MediaMuxer mediaMuxer;</span><br><span class="line">       <span class="keyword">private</span> <span class="type">int</span> <span class="variable">videoTrackIndex</span> <span class="operator">=</span> -<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">       <span class="keyword">public</span> <span class="title function_">VideoEncodecThread</span><span class="params">(WeakReference&lt;YorkBaseMediaEncoder&gt; encoder)</span> &#123;</span><br><span class="line">           <span class="built_in">this</span>.encoder = encoder;</span><br><span class="line">           videoEncodec = encoder.get().videoEncodec;</span><br><span class="line">           videoBufferinfo = encoder.get().videoBufferinfo;</span><br><span class="line">           mediaMuxer = encoder.get().mediaMuxer;</span><br><span class="line">           videoTrackIndex = -<span class="number">1</span>;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="meta">@Override</span></span><br><span class="line">       <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">           <span class="built_in">super</span>.run();</span><br><span class="line">           videoTrackIndex = -<span class="number">1</span>;</span><br><span class="line">           isExit = <span class="literal">false</span>;</span><br><span class="line">           videoEncodec.start();</span><br><span class="line">           <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">               <span class="keyword">if</span> (isExit) &#123;</span><br><span class="line">                   videoEncodec.stop();</span><br><span class="line">                   videoEncodec.release();</span><br><span class="line">                   videoEncodec = <span class="literal">null</span>;</span><br><span class="line">                   encoder.get().videoExit = <span class="literal">true</span>;</span><br><span class="line">                   <span class="keyword">if</span> (encoder.get().audioExit) &#123;</span><br><span class="line">                       mediaMuxer.stop();</span><br><span class="line">                       mediaMuxer.release();</span><br><span class="line">                       mediaMuxer = <span class="literal">null</span>;</span><br><span class="line">                   &#125;</span><br><span class="line">                   <span class="keyword">if</span> (encoder.get()!=<span class="literal">null</span>&amp;&amp;encoder.get().onMediaInfoListener!=<span class="literal">null</span>)&#123;</span><br><span class="line">                       encoder.get().onMediaInfoListener.onMediaRecordComple();</span><br><span class="line">                   &#125;</span><br><span class="line">                   <span class="keyword">break</span>;</span><br><span class="line">               &#125;</span><br><span class="line">               <span class="keyword">if</span> (videoEncodec==<span class="literal">null</span>)&#123;</span><br><span class="line">                   isExit=<span class="literal">true</span>;</span><br><span class="line">                   <span class="keyword">break</span>;</span><br><span class="line">               &#125;</span><br><span class="line">               <span class="type">int</span> <span class="variable">outputBufferIndex</span> <span class="operator">=</span> videoEncodec.dequeueOutputBuffer(videoBufferinfo, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">               <span class="keyword">if</span> (outputBufferIndex == MediaCodec.INFO_OUTPUT_FORMAT_CHANGED) &#123;</span><br><span class="line">                   videoTrackIndex = mediaMuxer.addTrack(videoEncodec.getOutputFormat());</span><br><span class="line">                   <span class="keyword">if</span> (encoder.get().audioEncodecThread.audioTrackIndex != -<span class="number">1</span>) &#123;</span><br><span class="line">                       mediaMuxer.start();</span><br><span class="line">                       encoder.get().encodecStart = <span class="literal">true</span>;</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                   <span class="keyword">while</span> (outputBufferIndex &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                       <span class="keyword">if</span> (encoder.get().encodecStart) &#123;</span><br><span class="line">                           <span class="type">ByteBuffer</span> <span class="variable">outputBuffer</span> <span class="operator">=</span> videoEncodec.getOutputBuffers()[outputBufferIndex];</span><br><span class="line">                           outputBuffer.position(videoBufferinfo.offset);</span><br><span class="line">                           outputBuffer.limit(videoBufferinfo.offset + videoBufferinfo.size);</span><br><span class="line">                           videoBufferinfo.presentationTimeUs = getPTSUs();</span><br><span class="line">                           mediaMuxer.writeSampleData(videoTrackIndex, outputBuffer, videoBufferinfo);</span><br><span class="line"></span><br><span class="line">                           <span class="keyword">if</span> (encoder.get()!=<span class="literal">null</span>&amp;&amp;encoder.get().onMediaInfoListener != <span class="literal">null</span>) &#123;</span><br><span class="line">                               encoder.get().onMediaInfoListener.onMediaTime((<span class="type">int</span>) (videoBufferinfo.presentationTimeUs / <span class="number">1000</span>));</span><br><span class="line">                           &#125;</span><br><span class="line">                       &#125;</span><br><span class="line">                       videoEncodec.releaseOutputBuffer(outputBufferIndex, <span class="literal">false</span>);</span><br><span class="line">                       outputBufferIndex = videoEncodec.dequeueOutputBuffer(videoBufferinfo, <span class="number">0</span>);</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">private</span> <span class="type">long</span> <span class="variable">baseTimeStamp</span> <span class="operator">=</span> -<span class="number">1</span>;</span><br><span class="line">       <span class="keyword">private</span> <span class="type">long</span> <span class="title function_">getPTSUs</span><span class="params">()</span> &#123;</span><br><span class="line">           <span class="type">long</span> <span class="variable">result</span> <span class="operator">=</span> System.nanoTime() ;</span><br><span class="line">           <span class="type">long</span> <span class="variable">time</span> <span class="operator">=</span> (result - baseTimeStamp ) / <span class="number">1000</span>;</span><br><span class="line">           <span class="keyword">if</span> (time &lt; <span class="number">0</span>)&#123;</span><br><span class="line">               <span class="keyword">return</span>  <span class="number">0</span>;</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">return</span> time;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">exit</span><span class="params">()</span> &#123;</span><br><span class="line">           isExit = <span class="literal">true</span>;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">   &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="3-1-3-音视频数据合并成MP4"><a href="#3-1-3-音视频数据合并成MP4" class="headerlink" title="3.1.3 音视频数据合并成MP4"></a>3.1.3 音视频数据合并成MP4</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mediaMuxer = <span class="keyword">new</span> <span class="title class_">MediaMuxer</span>(savePath, MediaMuxer.OutputFormat.MUXER_OUTPUT_MPEG_4);</span><br></pre></td></tr></table></figure>
<p>如上，在初始化时，已经设置了视频的文件保存路径 savePath， 以及其输出格式 MediaMuxer.OutputFormat.MUXER_OUTPUT_MPEG_4 。经过上面2个线程的同时写入。此时的 savePath 路径的MP4文件中已经有数据了。<br>使用 MediaMuxer 合并音视频过程有一个注意点，那就是保证音频视频时间戳的对应，否则将导致音视频不同步，或者程序报错。</p>
<p>音视频数据合并成MP4主要就是上面代码中的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mediaMuxer.writeSampleData(audioTrackIndex, outputBuffer, bufferInfo);</span><br></pre></td></tr></table></figure>
<p>和</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mediaMuxer.writeSampleData(videoTrackIndex, outputBuffer, videoBufferinfo);</span><br></pre></td></tr></table></figure>

<p>这2步，分别将已经编码好的音频轨道数据、和视频轨道数据传入了MediaMuxer。MediaMuxer进行音视频合并得到的也就是我们想要的.mp4文件。</p>
<p>完整代码：YorkBaseMediaEncoder.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.york.opensdk.opengl.encodec;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.content.Context;</span><br><span class="line"><span class="keyword">import</span> android.media.MediaCodec;</span><br><span class="line"><span class="keyword">import</span> android.media.MediaCodecInfo;</span><br><span class="line"><span class="keyword">import</span> android.media.MediaFormat;</span><br><span class="line"><span class="keyword">import</span> android.media.MediaMuxer;</span><br><span class="line"><span class="keyword">import</span> android.view.Surface;</span><br><span class="line"><span class="keyword">import</span> com.york.opensdk.opengl.egl.EglHelper;</span><br><span class="line"><span class="keyword">import</span> com.york.opensdk.opengl.egl.YorkEGLSurfaceView;</span><br><span class="line"><span class="keyword">import</span> com.york.opensdk.utils.LogAAR;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.lang.ref.WeakReference;</span><br><span class="line"><span class="keyword">import</span> java.nio.ByteBuffer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.microedition.khronos.egl.EGLContext;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">YorkBaseMediaEncoder</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Surface surface;</span><br><span class="line">    <span class="keyword">private</span> EGLContext eglContext;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> width;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> height;</span><br><span class="line">    <span class="keyword">private</span> MediaCodec videoEncodec;</span><br><span class="line">    <span class="keyword">private</span> MediaFormat videoFormat;</span><br><span class="line">    <span class="keyword">private</span> MediaCodec.BufferInfo videoBufferinfo;</span><br><span class="line">    <span class="keyword">private</span> MediaCodec audioEncodec;</span><br><span class="line">    <span class="keyword">private</span> MediaFormat audioFormat;</span><br><span class="line">    <span class="keyword">private</span> MediaCodec.BufferInfo audioBufferinfo;</span><br><span class="line">    <span class="keyword">private</span> MediaMuxer mediaMuxer;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> encodecStart;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> audioExit;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> videoExit;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> yorkEGLMediaThread yorkEGLMediaThread;</span><br><span class="line">    <span class="keyword">private</span> VideoEncodecThread videoEncodecThread;</span><br><span class="line">    <span class="keyword">private</span> AudioEncodecThread audioEncodecThread;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> YorkEGLSurfaceView.YorkGLRender yorkGLRender;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="type">int</span> <span class="variable">RENDERMODE_WHEN_DIRTY</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="type">int</span> <span class="variable">RENDERMODE_CONTINUOUSLY</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">mRenderMode</span> <span class="operator">=</span> RENDERMODE_CONTINUOUSLY;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> OnMediaInfoListener onMediaInfoListener;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">YorkBaseMediaEncoder</span><span class="params">(Context context)</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setRender</span><span class="params">(YorkEGLSurfaceView.YorkGLRender yorkGLRender)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.yorkGLRender = yorkGLRender;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setmRenderMode</span><span class="params">(<span class="type">int</span> mRenderMode)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (yorkGLRender == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;must set render before&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">this</span>.mRenderMode = mRenderMode;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setOnMediaInfoListener</span><span class="params">(OnMediaInfoListener onMediaInfoListener)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.onMediaInfoListener = onMediaInfoListener;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">initEncodec</span><span class="params">(EGLContext eglContext, String savePath, <span class="type">int</span> width, <span class="type">int</span> height, <span class="type">int</span> sampleRate, <span class="type">int</span> channelCount)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.width = width;</span><br><span class="line">        <span class="built_in">this</span>.height = height;</span><br><span class="line">        <span class="built_in">this</span>.eglContext = eglContext;</span><br><span class="line">        initMediaEncodec(savePath, width, height, sampleRate, channelCount);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">startRecord</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (surface != <span class="literal">null</span> &amp;&amp; eglContext != <span class="literal">null</span>) &#123;</span><br><span class="line">            audioExit = <span class="literal">false</span>;</span><br><span class="line">            videoExit = <span class="literal">false</span>;</span><br><span class="line">            encodecStart = <span class="literal">false</span>;</span><br><span class="line">            yorkEGLMediaThread = <span class="keyword">new</span> <span class="title class_">yorkEGLMediaThread</span>(<span class="keyword">new</span> <span class="title class_">WeakReference</span>&lt;YorkBaseMediaEncoder&gt;(<span class="built_in">this</span>));</span><br><span class="line">            videoEncodecThread = <span class="keyword">new</span> <span class="title class_">VideoEncodecThread</span>(<span class="keyword">new</span> <span class="title class_">WeakReference</span>&lt;YorkBaseMediaEncoder&gt;(<span class="built_in">this</span>));</span><br><span class="line">            audioEncodecThread = <span class="keyword">new</span> <span class="title class_">AudioEncodecThread</span>(<span class="keyword">new</span> <span class="title class_">WeakReference</span>&lt;YorkBaseMediaEncoder&gt;(<span class="built_in">this</span>));</span><br><span class="line">            audioEncodecThread.baseTimeStamp=System.nanoTime();</span><br><span class="line">            videoEncodecThread.baseTimeStamp=System.nanoTime();</span><br><span class="line">            yorkEGLMediaThread.isCreate = <span class="literal">true</span>;</span><br><span class="line">            yorkEGLMediaThread.isChange = <span class="literal">true</span>;</span><br><span class="line">            yorkEGLMediaThread.start();</span><br><span class="line">            videoEncodecThread.start();</span><br><span class="line">            audioEncodecThread.start();</span><br><span class="line">            <span class="keyword">if</span> (onMediaInfoListener!=<span class="literal">null</span>)&#123;</span><br><span class="line">                onMediaInfoListener.onMediaRecordStart();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">stopRecord</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (yorkEGLMediaThread != <span class="literal">null</span> &amp;&amp; videoEncodecThread != <span class="literal">null</span> &amp;&amp; audioEncodecThread != <span class="literal">null</span>) &#123;</span><br><span class="line">            videoEncodecThread.exit();</span><br><span class="line">            audioEncodecThread.exit();</span><br><span class="line">            yorkEGLMediaThread.onDestory();</span><br><span class="line">            audioEncodecThread.baseTimeStamp=-<span class="number">1</span>;</span><br><span class="line">            videoEncodecThread.baseTimeStamp=-<span class="number">1</span>;</span><br><span class="line">            videoEncodecThread = <span class="literal">null</span>;</span><br><span class="line">            yorkEGLMediaThread = <span class="literal">null</span>;</span><br><span class="line">            audioEncodecThread = <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">initMediaEncodec</span><span class="params">(String savePath, <span class="type">int</span> width, <span class="type">int</span> height, <span class="type">int</span> sampleRate, <span class="type">int</span> channelCount)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            LogAAR.e(<span class="string">&quot;initMediaEncodec:--&gt;savePath=&quot;</span>+savePath+<span class="string">&quot;,size: w * h =&quot;</span>+width+<span class="string">&quot;*&quot;</span>+height+<span class="string">&quot;,sampleRate=&quot;</span>+sampleRate+<span class="string">&quot;,channelCount=&quot;</span>+channelCount);</span><br><span class="line">            mediaMuxer = <span class="keyword">new</span> <span class="title class_">MediaMuxer</span>(savePath, MediaMuxer.OutputFormat.MUXER_OUTPUT_MPEG_4);</span><br><span class="line">            initVideoEncodec(MediaFormat.MIMETYPE_VIDEO_AVC, width, height);</span><br><span class="line">            initAudioEncodec(MediaFormat.MIMETYPE_AUDIO_AAC, sampleRate, channelCount);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">initVideoEncodec</span><span class="params">(String mimeType, <span class="type">int</span> width, <span class="type">int</span> height)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            videoBufferinfo = <span class="keyword">new</span> <span class="title class_">MediaCodec</span>.BufferInfo();</span><br><span class="line">            videoFormat = MediaFormat.createVideoFormat(mimeType, width, height);</span><br><span class="line">            videoFormat.setInteger(MediaFormat.KEY_COLOR_FORMAT, MediaCodecInfo.CodecCapabilities.COLOR_FormatSurface);</span><br><span class="line">            videoFormat.setInteger(MediaFormat.KEY_BIT_RATE, width * height * <span class="number">4</span>);</span><br><span class="line">            videoFormat.setInteger(MediaFormat.KEY_FRAME_RATE, <span class="number">30</span>);</span><br><span class="line">            videoFormat.setInteger(MediaFormat.KEY_I_FRAME_INTERVAL, <span class="number">1</span>);</span><br><span class="line">            videoEncodec = MediaCodec.createEncoderByType(mimeType);</span><br><span class="line">            videoEncodec.configure(videoFormat, <span class="literal">null</span>, <span class="literal">null</span>, MediaCodec.CONFIGURE_FLAG_ENCODE);</span><br><span class="line">            surface = videoEncodec.createInputSurface();</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            videoEncodec = <span class="literal">null</span>;</span><br><span class="line">            videoFormat = <span class="literal">null</span>;</span><br><span class="line">            videoBufferinfo = <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">initAudioEncodec</span><span class="params">(String mimeType, <span class="type">int</span> sampleRate, <span class="type">int</span> channelCount)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            audioBufferinfo = <span class="keyword">new</span> <span class="title class_">MediaCodec</span>.BufferInfo();</span><br><span class="line">            audioFormat = MediaFormat.createAudioFormat(mimeType, sampleRate, channelCount);</span><br><span class="line">            audioFormat.setInteger(MediaFormat.KEY_BIT_RATE, sampleRate*channelCount*<span class="number">16</span>);</span><br><span class="line">            audioFormat.setInteger(MediaFormat.KEY_AAC_PROFILE, MediaCodecInfo.CodecProfileLevel.AACObjectLC);</span><br><span class="line">            audioFormat.setInteger(MediaFormat.KEY_MAX_INPUT_SIZE, <span class="number">96000</span>);</span><br><span class="line"></span><br><span class="line">            audioEncodec = MediaCodec.createEncoderByType(mimeType);</span><br><span class="line">            audioEncodec.configure(audioFormat, <span class="literal">null</span>, <span class="literal">null</span>, MediaCodec.CONFIGURE_FLAG_ENCODE);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            audioBufferinfo = <span class="literal">null</span>;</span><br><span class="line">            audioFormat = <span class="literal">null</span>;</span><br><span class="line">            audioEncodec = <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">putPCMData</span><span class="params">(<span class="type">byte</span>[] buffer, <span class="type">int</span> size)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (audioEncodecThread != <span class="literal">null</span> &amp;&amp; !audioEncodecThread.isExit &amp;&amp; buffer != <span class="literal">null</span> &amp;&amp; size &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (audioEncodec!=<span class="literal">null</span>)&#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="type">int</span> <span class="variable">inputBufferindex</span> <span class="operator">=</span> audioEncodec.dequeueInputBuffer(<span class="number">0</span>);</span><br><span class="line">                    <span class="keyword">if</span> (inputBufferindex &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                        <span class="type">ByteBuffer</span> <span class="variable">byteBuffer</span> <span class="operator">=</span> audioEncodec.getInputBuffers()[inputBufferindex];</span><br><span class="line">                        byteBuffer.clear();</span><br><span class="line">                        byteBuffer.put(buffer);</span><br><span class="line">                        <span class="type">long</span> <span class="variable">result</span> <span class="operator">=</span> System.nanoTime() ;</span><br><span class="line">                        <span class="type">long</span> <span class="variable">time</span> <span class="operator">=</span> (result - audioEncodecThread.baseTimeStamp ) / <span class="number">1000</span>;</span><br><span class="line"></span><br><span class="line">                        audioEncodec.queueInputBuffer(inputBufferindex, <span class="number">0</span>, size, time, <span class="number">0</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">yorkEGLMediaThread</span> <span class="keyword">extends</span> <span class="title class_">Thread</span> &#123;</span><br><span class="line">        <span class="keyword">private</span> WeakReference&lt;YorkBaseMediaEncoder&gt; encoder;</span><br><span class="line">        <span class="keyword">private</span> EglHelper eglHelper;</span><br><span class="line">        <span class="keyword">private</span> Object object;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="type">boolean</span> <span class="variable">isExit</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="type">boolean</span> <span class="variable">isCreate</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="type">boolean</span> <span class="variable">isChange</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="type">boolean</span> <span class="variable">isStart</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">yorkEGLMediaThread</span><span class="params">(WeakReference&lt;YorkBaseMediaEncoder&gt; encoder)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.encoder = encoder;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="built_in">super</span>.run();</span><br><span class="line">            isExit = <span class="literal">false</span>;</span><br><span class="line">            isStart = <span class="literal">false</span>;</span><br><span class="line">            object = <span class="keyword">new</span> <span class="title class_">Object</span>();</span><br><span class="line">            eglHelper = <span class="keyword">new</span> <span class="title class_">EglHelper</span>();</span><br><span class="line">            eglHelper.initEgl(encoder.get().surface, encoder.get().eglContext);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (isExit) &#123;</span><br><span class="line">                    release();</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (isStart) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (encoder.get().mRenderMode == RENDERMODE_WHEN_DIRTY) &#123;</span><br><span class="line">                        <span class="keyword">synchronized</span> (object) &#123;</span><br><span class="line">                            <span class="keyword">try</span> &#123;</span><br><span class="line">                                object.wait();</span><br><span class="line">                            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                                e.printStackTrace();</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (encoder.get().mRenderMode == RENDERMODE_CONTINUOUSLY) &#123;</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            Thread.sleep(<span class="number">1000</span> / <span class="number">60</span>);</span><br><span class="line">                        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                            e.printStackTrace();</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;mRenderMode is wrong value&quot;</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                onCreate();</span><br><span class="line">                onChange(encoder.get().width, encoder.get().height);</span><br><span class="line">                onDraw();</span><br><span class="line">                isStart = <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (isCreate &amp;&amp; encoder.get().yorkGLRender != <span class="literal">null</span>) &#123;</span><br><span class="line">                isCreate = <span class="literal">false</span>;</span><br><span class="line">                encoder.get().yorkGLRender.onSurfaceCreated();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">onChange</span><span class="params">(<span class="type">int</span> width, <span class="type">int</span> height)</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (isChange &amp;&amp; encoder.get().yorkGLRender != <span class="literal">null</span>) &#123;</span><br><span class="line">                isChange = <span class="literal">false</span>;</span><br><span class="line">                encoder.get().yorkGLRender.onSurfaceChanged(width, height);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">onDraw</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (encoder.get().yorkGLRender != <span class="literal">null</span> &amp;&amp; eglHelper != <span class="literal">null</span>) &#123;</span><br><span class="line">                encoder.get().yorkGLRender.onDrawFrame();</span><br><span class="line">                <span class="keyword">if</span> (!isStart) &#123;</span><br><span class="line">                    encoder.get().yorkGLRender.onDrawFrame();</span><br><span class="line">                &#125;</span><br><span class="line">                eglHelper.swapBuffers();</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">requestRender</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (object != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">synchronized</span> (object) &#123;</span><br><span class="line">                    object.notifyAll();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onDestory</span><span class="params">()</span> &#123;</span><br><span class="line">            isExit = <span class="literal">true</span>;</span><br><span class="line">            requestRender();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">release</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (eglHelper != <span class="literal">null</span>) &#123;</span><br><span class="line">                eglHelper.destoryEgl();</span><br><span class="line">                eglHelper = <span class="literal">null</span>;</span><br><span class="line">                object = <span class="literal">null</span>;</span><br><span class="line">                encoder = <span class="literal">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">VideoEncodecThread</span> <span class="keyword">extends</span> <span class="title class_">Thread</span> &#123;</span><br><span class="line">        <span class="keyword">private</span> WeakReference&lt;YorkBaseMediaEncoder&gt; encoder;</span><br><span class="line">        <span class="keyword">private</span> <span class="type">boolean</span> isExit;</span><br><span class="line">        <span class="keyword">private</span> MediaCodec videoEncodec;</span><br><span class="line">        <span class="keyword">private</span> MediaCodec.BufferInfo videoBufferinfo;</span><br><span class="line">        <span class="keyword">private</span> MediaMuxer mediaMuxer;</span><br><span class="line">        <span class="keyword">private</span> <span class="type">int</span> <span class="variable">videoTrackIndex</span> <span class="operator">=</span> -<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">VideoEncodecThread</span><span class="params">(WeakReference&lt;YorkBaseMediaEncoder&gt; encoder)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.encoder = encoder;</span><br><span class="line">            videoEncodec = encoder.get().videoEncodec;</span><br><span class="line">            videoBufferinfo = encoder.get().videoBufferinfo;</span><br><span class="line">            mediaMuxer = encoder.get().mediaMuxer;</span><br><span class="line">            videoTrackIndex = -<span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="built_in">super</span>.run();</span><br><span class="line">            videoTrackIndex = -<span class="number">1</span>;</span><br><span class="line">            isExit = <span class="literal">false</span>;</span><br><span class="line">            videoEncodec.start();</span><br><span class="line">            <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (isExit) &#123;</span><br><span class="line">                    videoEncodec.stop();</span><br><span class="line">                    videoEncodec.release();</span><br><span class="line">                    videoEncodec = <span class="literal">null</span>;</span><br><span class="line">                    encoder.get().videoExit = <span class="literal">true</span>;</span><br><span class="line">                    <span class="keyword">if</span> (encoder.get().audioExit) &#123;</span><br><span class="line">                        mediaMuxer.stop();</span><br><span class="line">                        mediaMuxer.release();</span><br><span class="line">                        mediaMuxer = <span class="literal">null</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (encoder.get()!=<span class="literal">null</span>&amp;&amp;encoder.get().onMediaInfoListener!=<span class="literal">null</span>)&#123;</span><br><span class="line">                        encoder.get().onMediaInfoListener.onMediaRecordComple();</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (videoEncodec==<span class="literal">null</span>)&#123;</span><br><span class="line">                    isExit=<span class="literal">true</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="type">int</span> <span class="variable">outputBufferIndex</span> <span class="operator">=</span> videoEncodec.dequeueOutputBuffer(videoBufferinfo, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (outputBufferIndex == MediaCodec.INFO_OUTPUT_FORMAT_CHANGED) &#123;</span><br><span class="line">                    videoTrackIndex = mediaMuxer.addTrack(videoEncodec.getOutputFormat());</span><br><span class="line">                    <span class="keyword">if</span> (encoder.get().audioEncodecThread.audioTrackIndex != -<span class="number">1</span>) &#123;</span><br><span class="line">                        mediaMuxer.start();</span><br><span class="line">                        encoder.get().encodecStart = <span class="literal">true</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">while</span> (outputBufferIndex &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (encoder.get().encodecStart) &#123;</span><br><span class="line">                            <span class="type">ByteBuffer</span> <span class="variable">outputBuffer</span> <span class="operator">=</span> videoEncodec.getOutputBuffers()[outputBufferIndex];</span><br><span class="line">                            outputBuffer.position(videoBufferinfo.offset);</span><br><span class="line">                            outputBuffer.limit(videoBufferinfo.offset + videoBufferinfo.size);</span><br><span class="line">                            videoBufferinfo.presentationTimeUs = getPTSUs();</span><br><span class="line">                            mediaMuxer.writeSampleData(videoTrackIndex, outputBuffer, videoBufferinfo);</span><br><span class="line"></span><br><span class="line">                            <span class="keyword">if</span> (encoder.get()!=<span class="literal">null</span>&amp;&amp;encoder.get().onMediaInfoListener != <span class="literal">null</span>) &#123;</span><br><span class="line">                                encoder.get().onMediaInfoListener.onMediaTime((<span class="type">int</span>) (videoBufferinfo.presentationTimeUs / <span class="number">1000</span>));</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                        videoEncodec.releaseOutputBuffer(outputBufferIndex, <span class="literal">false</span>);</span><br><span class="line">                        outputBufferIndex = videoEncodec.dequeueOutputBuffer(videoBufferinfo, <span class="number">0</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">private</span> <span class="type">long</span> <span class="variable">baseTimeStamp</span> <span class="operator">=</span> -<span class="number">1</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="type">long</span> <span class="title function_">getPTSUs</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="type">long</span> <span class="variable">result</span> <span class="operator">=</span> System.nanoTime() ;</span><br><span class="line">            <span class="type">long</span> <span class="variable">time</span> <span class="operator">=</span> (result - baseTimeStamp ) / <span class="number">1000</span>;</span><br><span class="line">            <span class="keyword">if</span> (time &lt; <span class="number">0</span>)&#123;</span><br><span class="line">                <span class="keyword">return</span>  <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> time;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">exit</span><span class="params">()</span> &#123;</span><br><span class="line">            isExit = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">AudioEncodecThread</span> <span class="keyword">extends</span> <span class="title class_">Thread</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> WeakReference&lt;YorkBaseMediaEncoder&gt; encoder;</span><br><span class="line">        <span class="keyword">private</span> <span class="type">boolean</span> isExit;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> MediaCodec audioEncodec;</span><br><span class="line">        <span class="keyword">private</span> MediaCodec.BufferInfo bufferInfo;</span><br><span class="line">        <span class="keyword">private</span> MediaMuxer mediaMuxer;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="type">int</span> <span class="variable">audioTrackIndex</span> <span class="operator">=</span> -<span class="number">1</span>;</span><br><span class="line">        <span class="type">long</span> pts;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">AudioEncodecThread</span><span class="params">(WeakReference&lt;YorkBaseMediaEncoder&gt; encoder)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.encoder = encoder;</span><br><span class="line">            audioEncodec = encoder.get().audioEncodec;</span><br><span class="line">            bufferInfo = encoder.get().audioBufferinfo;</span><br><span class="line">            mediaMuxer = encoder.get().mediaMuxer;</span><br><span class="line">            audioTrackIndex = -<span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="built_in">super</span>.run();</span><br><span class="line">            pts = <span class="number">0</span>;</span><br><span class="line">            isExit = <span class="literal">false</span>;</span><br><span class="line">            audioEncodec.start();</span><br><span class="line">            <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (isExit) &#123;</span><br><span class="line">                    audioEncodec.stop();</span><br><span class="line">                    audioEncodec.release();</span><br><span class="line">                    audioEncodec = <span class="literal">null</span>;</span><br><span class="line">                    encoder.get().audioExit = <span class="literal">true</span>;</span><br><span class="line">                    <span class="keyword">if</span> (encoder.get().videoExit) &#123;</span><br><span class="line">                        mediaMuxer.stop();</span><br><span class="line">                        mediaMuxer.release();</span><br><span class="line">                        mediaMuxer = <span class="literal">null</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (audioEncodec==<span class="literal">null</span>)&#123;</span><br><span class="line">                    isExit=<span class="literal">true</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="type">int</span> <span class="variable">outputBufferIndex</span> <span class="operator">=</span> audioEncodec.dequeueOutputBuffer(bufferInfo, <span class="number">0</span>);</span><br><span class="line">                <span class="keyword">if</span> (outputBufferIndex == MediaCodec.INFO_OUTPUT_FORMAT_CHANGED) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (mediaMuxer != <span class="literal">null</span>) &#123;</span><br><span class="line">                        audioTrackIndex = mediaMuxer.addTrack(audioEncodec.getOutputFormat());</span><br><span class="line">                        <span class="keyword">if</span> (encoder.get().videoEncodecThread.videoTrackIndex != -<span class="number">1</span>) &#123;</span><br><span class="line">                            mediaMuxer.start();</span><br><span class="line">                            encoder.get().encodecStart = <span class="literal">true</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">while</span> (outputBufferIndex &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (encoder.get().encodecStart) &#123;</span><br><span class="line">                            <span class="type">ByteBuffer</span> <span class="variable">outputBuffer</span> <span class="operator">=</span> audioEncodec.getOutputBuffers()[outputBufferIndex];</span><br><span class="line">                            outputBuffer.position(bufferInfo.offset);</span><br><span class="line">                            outputBuffer.limit(bufferInfo.offset + bufferInfo.size);</span><br><span class="line">                            bufferInfo.presentationTimeUs = getPTSUs();</span><br><span class="line">                            mediaMuxer.writeSampleData(audioTrackIndex, outputBuffer, bufferInfo);</span><br><span class="line">                        &#125;</span><br><span class="line">                        audioEncodec.releaseOutputBuffer(outputBufferIndex, <span class="literal">false</span>);</span><br><span class="line">                        outputBufferIndex = audioEncodec.dequeueOutputBuffer(bufferInfo, <span class="number">0</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">private</span> <span class="type">long</span> <span class="variable">baseTimeStamp</span> <span class="operator">=</span> -<span class="number">1</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="type">long</span> <span class="title function_">getPTSUs</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="type">long</span> <span class="variable">result</span> <span class="operator">=</span> System.nanoTime() ;</span><br><span class="line">            <span class="type">long</span> <span class="variable">time</span> <span class="operator">=</span> (result - baseTimeStamp ) / <span class="number">1000</span>;</span><br><span class="line">            <span class="keyword">if</span> (time &lt; <span class="number">0</span>)&#123;</span><br><span class="line">                <span class="keyword">return</span>  <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> time;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">exit</span><span class="params">()</span> &#123;</span><br><span class="line">            isExit = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">OnMediaInfoListener</span> &#123;</span><br><span class="line">        <span class="keyword">void</span> <span class="title function_">onMediaRecordStart</span><span class="params">()</span>;</span><br><span class="line">        <span class="keyword">void</span> <span class="title function_">onMediaTime</span><span class="params">(<span class="type">int</span> times)</span>;</span><br><span class="line">        <span class="keyword">void</span> <span class="title function_">onMediaRecordComple</span><span class="params">()</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p><em>以上就是一个.MP4文件的录制过程</em></p>
<h2 id="3-2-MP4-文件解码播放"><a href="#3-2-MP4-文件解码播放" class="headerlink" title="3.2 MP4 文件解码播放"></a>3.2 MP4 文件解码播放</h2><p>关于MP4 文件的播放，先再看一下MP4文件播放流程的简单框图：</p>
<p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly93d3cueW9ya3l1ZS5jb20vcGljcy9jdXRfdmlkZW9fcGxheV9zdGVwLnBuZw?x-oss-process=image/format,png" alt="在这里插入图片描述"></p>
<p>图中MP4播放的过程主要有以下流程：</p>
<ul>
<li>FFmpeg 解码得到 Avpacket</li>
<li>音频重采样 Avframe 得到 PCM</li>
<li>OpenSL ES 播放 PCM 扬声器发出声音</li>
<li>视频硬&#x2F;软解码得到图像数据</li>
<li>OpenGL 渲染 YUV 数据在屏幕上显示</li>
</ul>
<p>之所以采用这种方式播放MP4文件，是因为这种方式更能体现出一个视频文件播放的每一个具体步骤。我们还可以了解音频解码、重采样；视频的硬解码、软解码过程，同时也能加深对安卓音视频开发的理解。</p>
<p>关于FFmpeg的使用，本篇文章里不会对它的每一个步骤细讲，之后我会将这部分内容单独开一篇文章来叙述，在这篇文章中，我们会涉及到FFmpeg的编译、集成、使用，以及音视频播放器SDK的封装等，重点也是在 NDK开发。有兴趣的盆友可以看一下。</p>
<p>预告一下，播放器中会有这些基本功能，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.york.opensdk.media;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.media.MediaCodec;</span><br><span class="line"><span class="keyword">import</span> android.media.MediaFormat;</span><br><span class="line"><span class="keyword">import</span> android.text.TextUtils;</span><br><span class="line"><span class="keyword">import</span> android.view.Surface;</span><br><span class="line"><span class="keyword">import</span> com.york.opensdk.listner.PlayerObservable;</span><br><span class="line"><span class="keyword">import</span> com.york.opensdk.listner.PlayerOnFileCodecListener;</span><br><span class="line"><span class="keyword">import</span> com.york.opensdk.listner.PlayerOnParpareListener;</span><br><span class="line"><span class="keyword">import</span> com.york.opensdk.listner.PlayerStatusListener;</span><br><span class="line"><span class="keyword">import</span> com.york.opensdk.utils.BitConverter;</span><br><span class="line"><span class="keyword">import</span> com.york.opensdk.utils.VideoSupportUitl;</span><br><span class="line"><span class="keyword">import</span> com.york.opensdk.utils.LogAAR;</span><br><span class="line"><span class="keyword">import</span> com.york.opensdk.utils.ToolUtils;</span><br><span class="line"><span class="keyword">import</span> com.york.opensdk.opengl.videoplay.YorkGLSurfacePlayView;</span><br><span class="line"><span class="keyword">import</span> com.york.opensdk.opengl.videoplay.YorkRender;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.nio.ByteBuffer;</span><br><span class="line"><span class="keyword">import</span> java.util.Observable;</span><br><span class="line"><span class="keyword">import</span> java.util.Observer;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by 86158 on 2019/8/3.</span></span><br><span class="line"><span class="comment"> * 支持音频和视频播放</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OpenPlayer</span> <span class="keyword">implements</span> <span class="title class_">Observer</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String source;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="variable">playNext</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">private</span> PlayerStatusListener mPlayerStatusListener;</span><br><span class="line">    <span class="keyword">private</span> PlayerOnParpareListener mPlayerOnParpareListener;</span><br><span class="line">    <span class="keyword">private</span> PlayerOnFileCodecListener mPlayerOnFileCodecListener;</span><br><span class="line">    <span class="keyword">private</span> YorkGLSurfacePlayView mGLSurfacePlayView;</span><br><span class="line">    <span class="keyword">private</span> MediaFormat mediaFormat;</span><br><span class="line">    <span class="keyword">private</span> MediaCodec mediaCodec;</span><br><span class="line">    <span class="keyword">private</span> Surface surface;</span><br><span class="line">    <span class="keyword">private</span> MediaCodec.BufferInfo info;</span><br><span class="line">    <span class="keyword">private</span> PlayerObservable mPlayerObservable;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">PLAY_STOP</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">PLAY_PAUSE</span> <span class="operator">=</span> <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">PLAYING</span> <span class="operator">=</span> <span class="number">3</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">OpenPlayer</span><span class="params">()</span> &#123;</span><br><span class="line">        mPlayerObservable = <span class="keyword">new</span> <span class="title class_">PlayerObservable</span>();</span><br><span class="line">        mPlayerObservable.addObserver(<span class="built_in">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">update</span><span class="params">(Observable o, Object arg)</span> &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        System.loadLibrary(<span class="string">&quot;player_lib&quot;</span>);</span><br><span class="line">        System.loadLibrary(<span class="string">&quot;avcodec-57&quot;</span>);</span><br><span class="line">        System.loadLibrary(<span class="string">&quot;avformat-57&quot;</span>);</span><br><span class="line">        System.loadLibrary(<span class="string">&quot;avutil-55&quot;</span>);</span><br><span class="line">        System.loadLibrary(<span class="string">&quot;swresample-2&quot;</span>);</span><br><span class="line">        System.loadLibrary(<span class="string">&quot;swscale-4&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setYorkGLSurfaceView</span><span class="params">(YorkGLSurfacePlayView yorkGLSurfacePlayView)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.mGLSurfacePlayView = yorkGLSurfacePlayView;</span><br><span class="line">        <span class="keyword">if</span> (mGLSurfacePlayView != <span class="literal">null</span>) &#123;</span><br><span class="line">            mGLSurfacePlayView.getWlRender().setOnSurfaceCreateListener(<span class="keyword">new</span> <span class="title class_">YorkRender</span>.OnSurfaceCreateListener() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onSurfaceCreate</span><span class="params">(Surface mSurface)</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (surface == <span class="literal">null</span>) &#123;</span><br><span class="line">                        surface = mSurface;</span><br><span class="line">                        LogAAR.d(<span class="string">&quot;onSurfaceCreate&quot;</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> YorkGLSurfacePlayView <span class="title function_">getGLSurfacePlayView</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> mGLSurfacePlayView;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setPlayerStatusListener</span><span class="params">(PlayerStatusListener mPlayerStatusListener)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.mPlayerStatusListener = mPlayerStatusListener;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setOpenPlayOnParpare</span><span class="params">(PlayerOnParpareListener mPlayerOnParpareListener)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.mPlayerOnParpareListener = mPlayerOnParpareListener;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setPlayerOnFileCodecListener</span><span class="params">(PlayerOnFileCodecListener mPlayerOnFileCodecListener)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.mPlayerOnFileCodecListener = mPlayerOnFileCodecListener;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> PlayerObservable <span class="title function_">getPlayerObservable</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> mPlayerObservable;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*********************************************** player callback ************************************************/</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">onCallParpared</span><span class="params">()</span> &#123;</span><br><span class="line">        LogAAR.i(<span class="string">&quot;onParpared&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (mPlayerStatusListener != <span class="literal">null</span>) &#123;</span><br><span class="line">            mPlayerStatusListener.onParpared();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (mPlayerOnParpareListener != <span class="literal">null</span>) &#123;</span><br><span class="line">            mPlayerOnParpareListener.OnParpare();</span><br><span class="line">        &#125;</span><br><span class="line">        mPlayerObservable.onParpare();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">onCallLoad</span><span class="params">(<span class="type">boolean</span> load)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (mPlayerStatusListener != <span class="literal">null</span>) &#123;</span><br><span class="line">            mPlayerStatusListener.onLoad(load);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">onCallComplete</span><span class="params">(<span class="type">boolean</span> isDoStop)</span> &#123;</span><br><span class="line">        LogAAR.i(<span class="string">&quot;onComplete -&gt;isDoStop=&quot;</span> + isDoStop);</span><br><span class="line">        <span class="keyword">if</span> (mPlayerStatusListener != <span class="literal">null</span>) &#123;</span><br><span class="line">            mPlayerStatusListener.onOnComplete(isDoStop);</span><br><span class="line">        &#125;</span><br><span class="line">        mPlayerObservable.onOnComplete(isDoStop);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">onCallPlayValumeDB</span><span class="params">(<span class="type">int</span> chenell, <span class="type">int</span> db, <span class="type">int</span> left_db, <span class="type">int</span> right_db)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (mPlayerStatusListener != <span class="literal">null</span>) &#123;</span><br><span class="line">            mPlayerStatusListener.onPlayValumeDB(chenell, db, left_db, right_db);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">onCallError</span><span class="params">(<span class="type">int</span> cord, String msg)</span> &#123;</span><br><span class="line">        LogAAR.e(<span class="string">&quot;cord = &quot;</span> + cord + <span class="string">&quot;,msg = &quot;</span> + msg);</span><br><span class="line">        <span class="keyword">if</span> (mPlayerStatusListener != <span class="literal">null</span>) &#123;</span><br><span class="line">            mPlayerStatusListener.onError(cord, msg);</span><br><span class="line">        &#125;</span><br><span class="line">        mPlayerObservable.onError();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">onCallNext</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (playNext) &#123;</span><br><span class="line">            playNext = <span class="literal">false</span>;</span><br><span class="line">            parparePlay();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">onAudioData</span><span class="params">(<span class="type">byte</span>[] buffer, <span class="type">int</span> chenell, <span class="type">int</span> size)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">byte</span>[] leftData = <span class="keyword">new</span> <span class="title class_">byte</span>[buffer.length];</span><br><span class="line">        <span class="type">byte</span>[] rightData = <span class="keyword">new</span> <span class="title class_">byte</span>[buffer.length];</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; buffer.length / <span class="number">2</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (i % <span class="number">2</span> == <span class="number">0</span>) &#123;</span><br><span class="line">                System.arraycopy(buffer, i * <span class="number">2</span>, leftData, i, <span class="number">2</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                System.arraycopy(buffer, i * <span class="number">2</span>, rightData, i - <span class="number">1</span>, <span class="number">2</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">short</span>[] left = BitConverter.toShorts(leftData);</span><br><span class="line">        <span class="type">short</span>[] right = BitConverter.toShorts(rightData);</span><br><span class="line">        <span class="type">short</span>[] midle = BitConverter.toShorts(buffer);</span><br><span class="line">        <span class="type">int</span> <span class="variable">left_db</span> <span class="operator">=</span> (<span class="type">int</span>) ToolUtils.getDB(left, size);</span><br><span class="line">        <span class="type">int</span> <span class="variable">right_db</span> <span class="operator">=</span> (<span class="type">int</span>) ToolUtils.getDB(right, size);</span><br><span class="line">        <span class="type">int</span> <span class="variable">midle_db</span> <span class="operator">=</span> (<span class="type">int</span>) ToolUtils.getDB(midle, size);</span><br><span class="line">        <span class="keyword">if</span> (mPlayerStatusListener != <span class="literal">null</span>) &#123;</span><br><span class="line">            mPlayerStatusListener.onPcmData(buffer, size);</span><br><span class="line">            mPlayerStatusListener.onPlayValumeDB(chenell, midle_db, left_db, right_db);</span><br><span class="line">            <span class="keyword">if</span> ( getPlayStates() == PLAYING)&#123;</span><br><span class="line">                mPlayerObservable.onTimeInfo(n_get_current(),n_get_duration());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">onPCMdown</span><span class="params">()</span> &#123;</span><br><span class="line">        LogAAR.i(<span class="string">&quot;onPCMdown&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (mPlayerOnFileCodecListener != <span class="literal">null</span>) &#123;</span><br><span class="line">            mPlayerOnFileCodecListener.onPcmDown();</span><br><span class="line">        &#125;</span><br><span class="line">        n_release_decode();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">onDecodePosition</span><span class="params">(<span class="type">double</span> pos)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (mPlayerOnFileCodecListener != <span class="literal">null</span>) &#123;</span><br><span class="line">            mPlayerOnFileCodecListener.onDecodePosition(pos);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onCallRenderYUV</span><span class="params">(<span class="type">int</span> width, <span class="type">int</span> height, <span class="type">byte</span>[] y, <span class="type">byte</span>[] u, <span class="type">byte</span>[] v)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (mGLSurfacePlayView != <span class="literal">null</span>) &#123;</span><br><span class="line">            mGLSurfacePlayView.getWlRender().setRenderType(YorkRender.RENDER_YUV);</span><br><span class="line">            mGLSurfacePlayView.setYUVData(width, height, y, u, v);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">onCallIsSupportMediaCodec</span><span class="params">(String ffcodecname)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> VideoSupportUitl.isSupportCodec(ffcodecname);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 初始化MediaCodec,供底层用</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> codecName</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> width</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> height</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> csd_0</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> csd_1</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">initMediaCodec</span><span class="params">(String codecName, <span class="type">int</span> width, <span class="type">int</span> height, <span class="type">byte</span>[] csd_0, <span class="type">byte</span>[] csd_1)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (surface != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                mGLSurfacePlayView.getWlRender().setRenderType(YorkRender.RENDER_MEDIACODEC);</span><br><span class="line">                <span class="type">String</span> <span class="variable">mime</span> <span class="operator">=</span> VideoSupportUitl.findVideoCodecName(codecName);</span><br><span class="line">                mediaFormat = MediaFormat.createVideoFormat(mime, width, height);</span><br><span class="line">                mediaFormat.setInteger(MediaFormat.KEY_MAX_INPUT_SIZE, width * height);</span><br><span class="line">                mediaFormat.setByteBuffer(<span class="string">&quot;csd-0&quot;</span>, ByteBuffer.wrap(csd_0));</span><br><span class="line">                mediaFormat.setByteBuffer(<span class="string">&quot;csd-1&quot;</span>, ByteBuffer.wrap(csd_1));</span><br><span class="line">                LogAAR.d(mediaFormat.toString());</span><br><span class="line">                mediaCodec = MediaCodec.createDecoderByType(mime);</span><br><span class="line"></span><br><span class="line">                info = <span class="keyword">new</span> <span class="title class_">MediaCodec</span>.BufferInfo();</span><br><span class="line">                mediaCodec.configure(mediaFormat, surface, <span class="literal">null</span>, <span class="number">0</span>);</span><br><span class="line">                mediaCodec.start();</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (mPlayerStatusListener != <span class="literal">null</span>) &#123;</span><br><span class="line">                onCallError(<span class="number">2001</span>, <span class="string">&quot;surface is null&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 供底层用</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> datasize</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> data</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">decodeAVPacket</span><span class="params">(<span class="type">int</span> datasize, <span class="type">byte</span>[] data)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (surface != <span class="literal">null</span> &amp;&amp; datasize &gt; <span class="number">0</span> &amp;&amp; data != <span class="literal">null</span> &amp;&amp; mediaCodec != <span class="literal">null</span>) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="type">int</span> <span class="variable">intputBufferIndex</span> <span class="operator">=</span> mediaCodec.dequeueInputBuffer(<span class="number">10</span>);</span><br><span class="line">            <span class="keyword">if</span> (intputBufferIndex &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="type">ByteBuffer</span> <span class="variable">byteBuffer</span> <span class="operator">=</span> mediaCodec.getInputBuffers()[intputBufferIndex];</span><br><span class="line">                byteBuffer.clear();</span><br><span class="line">                byteBuffer.put(data);</span><br><span class="line">                mediaCodec.queueInputBuffer(intputBufferIndex, <span class="number">0</span>, datasize, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (info == <span class="literal">null</span>) &#123;</span><br><span class="line">                info = <span class="keyword">new</span> <span class="title class_">MediaCodec</span>.BufferInfo();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">int</span> <span class="variable">outputBufferIndex</span> <span class="operator">=</span> mediaCodec.dequeueOutputBuffer(info, <span class="number">10</span>);</span><br><span class="line">            <span class="keyword">while</span> (outputBufferIndex &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (mediaCodec != <span class="literal">null</span>) &#123;</span><br><span class="line">                    mediaCodec.releaseOutputBuffer(outputBufferIndex, <span class="literal">true</span>);</span><br><span class="line">                    outputBufferIndex = mediaCodec.dequeueOutputBuffer(info, <span class="number">10</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">releaseMediacodec</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (mediaCodec != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                mediaCodec.flush();</span><br><span class="line">                mediaCodec.stop();</span><br><span class="line">                mediaCodec.release();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                <span class="comment">//e.printStackTrace();</span></span><br><span class="line">            &#125;</span><br><span class="line">            mediaFormat = <span class="literal">null</span>;</span><br><span class="line">            info = <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/********************************************** player method *************************************************/</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setSource</span><span class="params">(String source)</span> &#123;</span><br><span class="line">        LogAAR.d(<span class="string">&quot;setSource:source=&quot;</span>+source);</span><br><span class="line">        stopPlay();</span><br><span class="line">        <span class="built_in">this</span>.source = source;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">parparePlay</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (TextUtils.isEmpty(source)) &#123;</span><br><span class="line">            LogAAR.e(<span class="string">&quot;source not be null&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        LogAAR.d(<span class="string">&quot;parparePlay&quot;</span>);</span><br><span class="line">        n_parpare_play(source);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">startPlay</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (TextUtils.isEmpty(source)) &#123;</span><br><span class="line">            LogAAR.e(<span class="string">&quot;source not be null&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        LogAAR.d(<span class="string">&quot;startPlay&quot;</span>);</span><br><span class="line">        n_start_play();</span><br><span class="line">        mPlayerObservable.onPlaying();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">seekPlay</span><span class="params">(<span class="type">double</span> secd)</span> &#123;</span><br><span class="line">        n_seek_play(secd);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">pausePlay</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (getPlayStates() == <span class="number">3</span>) &#123;</span><br><span class="line">            LogAAR.d(<span class="string">&quot;pausePlay&quot;</span>);</span><br><span class="line">            n_pause_play();</span><br><span class="line">            <span class="keyword">if</span> (mPlayerStatusListener != <span class="literal">null</span>) &#123;</span><br><span class="line">                mPlayerStatusListener.onPause(<span class="literal">true</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        mPlayerObservable.onPause();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">resumePlay</span><span class="params">()</span> &#123;</span><br><span class="line">        LogAAR.d(<span class="string">&quot;resumePlay&quot;</span>);</span><br><span class="line">        n_resume_play();</span><br><span class="line">        <span class="keyword">if</span> (mPlayerStatusListener != <span class="literal">null</span>) &#123;</span><br><span class="line">            mPlayerStatusListener.onPause(<span class="literal">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        mPlayerObservable.onPlaying();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">stopPlay</span><span class="params">()</span> &#123;</span><br><span class="line">        LogAAR.d(<span class="string">&quot;stopPlay&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (!TextUtils.isEmpty(source)) &#123;</span><br><span class="line">            n_stop_play();</span><br><span class="line">            releaseMediacodec();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">playNext</span><span class="params">(String url)</span> &#123;</span><br><span class="line">        LogAAR.d(<span class="string">&quot;playNext: url=&quot;</span>+url);</span><br><span class="line">        <span class="built_in">this</span>.source = url;</span><br><span class="line">        playNext = <span class="literal">true</span>;</span><br><span class="line">        stopPlay();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setVolume</span><span class="params">(<span class="type">int</span> percent)</span> &#123;</span><br><span class="line">        LogAAR.d(<span class="string">&quot;setVolume: percent=&quot;</span>+percent);</span><br><span class="line">        <span class="keyword">if</span> (percent &gt;= <span class="number">0</span> &amp;&amp; percent &lt;= <span class="number">100</span>) &#123;</span><br><span class="line">            n_volume(percent);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setMute</span><span class="params">(<span class="type">int</span> mute)</span> &#123;</span><br><span class="line">        LogAAR.d(<span class="string">&quot;setMute: mute=&quot;</span>+mute);</span><br><span class="line">        n_mute(mute);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setPitch</span><span class="params">(<span class="type">float</span> pitch)</span> &#123;</span><br><span class="line">        LogAAR.d(<span class="string">&quot;setPitch: pitch=&quot;</span>+pitch);</span><br><span class="line">        n_pitch(pitch);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setSpeed</span><span class="params">(<span class="type">float</span> speed)</span> &#123;</span><br><span class="line">        LogAAR.d(<span class="string">&quot;setSpeed: speed=&quot;</span>+speed);</span><br><span class="line">        n_speed(speed);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">long</span> <span class="title function_">getDuration</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> n_get_duration();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">long</span> <span class="title function_">getCurrent</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> n_get_current();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 1.stop;2.pause;3.playing;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getPlayStates</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">int</span> states=n_get_play_states();</span><br><span class="line">        <span class="keyword">return</span> states;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">decodeFile</span><span class="params">(String source)</span> &#123;</span><br><span class="line">        n_decode_audio(source);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setRecordTempPath</span><span class="params">(String path)</span> &#123;</span><br><span class="line">        n_set_sava_dir(path);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">release</span><span class="params">()</span> &#123;</span><br><span class="line">        stopPlay();</span><br><span class="line">        n_release();</span><br><span class="line">        <span class="keyword">if</span> (mediaCodec != <span class="literal">null</span>) &#123;</span><br><span class="line">            mediaCodec = <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        mPlayerObservable.deleteObserver(<span class="built_in">this</span>);</span><br><span class="line">        mPlayerStatusListener = <span class="literal">null</span>;</span><br><span class="line">        mPlayerOnParpareListener = <span class="literal">null</span>;</span><br><span class="line">        mPlayerOnFileCodecListener = <span class="literal">null</span>;</span><br><span class="line">        mGLSurfacePlayView = <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/********************************** 音视频 ****************************************/</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title function_">n_parpare_play</span><span class="params">(String url)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title function_">n_start_play</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title function_">n_pause_play</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title function_">n_resume_play</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title function_">n_seek_play</span><span class="params">(<span class="type">double</span> secd)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">native</span> <span class="type">int</span> <span class="title function_">n_duration</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title function_">n_stop_play</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title function_">n_set_sava_dir</span><span class="params">(String path)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title function_">n_release</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title function_">n_release_decode</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title function_">n_decode_audio</span><span class="params">(String path)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">native</span> <span class="type">int</span> <span class="title function_">n_get_play_states</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title function_">n_volume</span><span class="params">(<span class="type">int</span> percent)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title function_">n_mute</span><span class="params">(<span class="type">int</span> mute)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title function_">n_pitch</span><span class="params">(<span class="type">float</span> pitch)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title function_">n_speed</span><span class="params">(<span class="type">float</span> speed)</span>;<span class="comment">// 视频0.5--2.0倍，音频0--5倍都可以</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">native</span> <span class="type">long</span> <span class="title function_">n_get_current</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">native</span> <span class="type">long</span> <span class="title function_">n_get_duration</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><em>好了，以上就是音视频编解码的内容整理，更多的内容可以看一下我的后续文章。感谢观看</em></p>

        </div>

        
        <section class="post-tags">
            <div>
                <span>Tag(s):</span>
                <span class="tag">
                    
                    
                        <a href="/tags/%E9%9F%B3%E8%A7%86%E9%A2%91/"># 音视频</a>
                    
                        
                </span>
            </div>
            <div>
                <a href="javascript:window.history.back();">back</a>
                <span>· </span>
                <a href="/">home</a>
            </div>
        </section>
        <section class="post-nav">
            
                <a class="prev" rel="prev" href="/2019/08/20/Ubuntu%20%E6%9C%8D%E5%8A%A1%E5%99%A8Tomcat%E9%85%8D%E7%BD%AE%E8%AF%81%E4%B9%A6%E5%AE%9E%E7%8E%B0Https/">Ubuntu 服务器Tomcat配置证书实现Https</a>
            
            
            <a class="next" rel="next" href="/2019/08/16/%E5%AE%89%E5%8D%93%E9%9F%B3%E8%A7%86%E9%A2%91%E2%80%94%E2%80%94%E9%9F%B3%E9%A2%91%E6%A8%A1%E5%9D%97/">安卓音视频——音频模块</a>
            
        </section>


    </article>
</div>

            </div>
            <footer id="footer" class="footer">
    <div class="copyright">
        <span>Copyright © 2019 - 2023 Designed by York</span>
    </div>
</footer>

    </div>
</body>

</html>